<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>VICO POCKET OS - ELITE v14</title>
    <meta name="theme-color" content="#0b0f1a">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b0f1a; --primary: #3b82f6; --glass: rgba(255,255,255,0.03); --border: rgba(59,130,246,0.15); }

        body.theme-Cyber  { --bg: #0b0f1a; --primary: #00fff7; }
        body.theme-Gold   { --bg: #1a1605; --primary: #fbbf24; }
        body.theme-Nature { --bg: #051a0b; --primary: #10b981; }
        body.theme-Nebula { --bg: #13051a; --primary: #d946ef; }
        body.theme-Minimal{ --bg: #000000; --primary: #ffffff; }

        body.mode-light { --bg: #f8fafc; --glass: rgba(0,0,0,0.03); --border: rgba(0,0,0,0.1); color: #1e293b; }
        body.mode-light .glass-panel { background: rgba(255,255,255,0.85) !important; border: 1px solid rgba(0,0,0,0.1); color: #1e293b; }
        body.mode-light input, body.mode-light textarea, body.mode-light select { background: #fff !important; color: #000 !important; border: 1px solid #cbd5e1 !important; }
        body.mode-light .nav-bar { background: #ffffff; border-top: 1px solid #e2e8f0; }
        body.mode-light .nav-item { color: #94a3b8; }

        body.font-sm     { font-size: 11px; }
        body.font-normal { font-size: 14px; }
        body.font-lg     { font-size: 18px; }

        body { background-color: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; transition: 0.3s; margin: 0; overflow: hidden; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .glass-panel { background: rgba(11,15,26,0.92); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .hidden { display: none !important; }

        .task-bar { position: fixed; top: 0; left: 0; width: 100%; height: 38px; background: rgba(0,0,0,0.92); z-index: 500; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid var(--border); }
        .nav-bar  { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: rgba(11,15,26,0.98); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: 10px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #475569; font-size: 8px; cursor: pointer; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active i { transform: translateY(-3px); filter: drop-shadow(0 0 5px var(--primary)); }

        input, textarea, select { background: rgba(0,0,0,0.6) !important; border: 1px solid rgba(255,255,255,0.1) !important; color: white !important; border-radius: 12px; outline: none; padding: 12px; appearance: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chip-active { background: var(--primary); color: black; font-weight: bold; box-shadow: 0 0 10px var(--primary); }

        @keyframes ring    { 0%,100%{transform:scale(1);}50%{transform:scale(1.03);border-color:red;} }
        @keyframes fadeIn  { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
        @keyframes brainScroll { from{transform:translateY(100%);}to{transform:translateY(-100%);} }
        @keyframes borderHalo  { 0%{clip-path:inset(0 0 95% 0);}25%{clip-path:inset(0 95% 0 0);}50%{clip-path:inset(95% 0 0 0);}75%{clip-path:inset(0 0 0 95%);}100%{clip-path:inset(0 0 95% 0);} }
        @keyframes notifSlide  { from{opacity:0;transform:translateX(100%);}to{opacity:1;transform:translateX(0);} }

        .alarm-active { animation: ring 0.5s infinite; border: 2px solid red !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }

        .logo-container { position: relative; padding: 10px; border-radius: 20px; transition: 0.5s; overflow: hidden; }
        .logo-container::before { content:''; position:absolute; inset:0; border:2px solid transparent; border-radius:20px; transition:0.5s; }
        .logo-container:hover::before { border-color:#fff; box-shadow:0 0 20px #fff; animation:borderHalo 2s linear infinite; }
        .matrix-rain { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); color:#0f0; font-family:monospace; font-size:8px; display:none; pointer-events:none; z-index:10; padding:5px; border:1px solid #0ff; }
        .logo-container:hover .matrix-rain { display:block; }

        .kanban-col  { min-width: 160px; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 12px; border: 1px dashed var(--border); }
        .kanban-card { background: var(--glass); border-radius: 12px; padding: 10px; margin-bottom: 8px; font-size: 11px; border-left: 4px solid var(--primary); cursor: grab; position: relative; }

        .news-card { background: rgba(255,255,255,0.02); border-radius: 28px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden; transition: 0.3s; margin-bottom: 15px; }
        .news-card:hover { border-color: var(--primary); transform: translateY(-2px); }

        .chat-bubble { max-width: 85%; padding: 12px; border-radius: 18px; margin-bottom: 8px; font-size: 11px; line-height: 1.4; }
        .chat-user { background: var(--primary); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-bot  { background: rgba(255,255,255,0.05); color: #fff; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--border); }

        .microwave-door { background: rgba(0,255,247,0.05); border: 2px solid var(--primary); position: relative; overflow: hidden; }
        .thinking-text  { font-family: 'Courier New', monospace; font-size: 9px; color: #0f0; text-shadow: 0 0 5px #0f0; animation: brainScroll 10s linear infinite; }
        .timer-knob { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #334155; position: relative; background: conic-gradient(var(--primary) var(--progress), transparent 0deg); }
        .timer-knob::after { content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:30px; height:30px; background:#0f172a; border-radius:50%; }

        /* NOTIFICACI√ìN TOAST IN-APP */
        #vico-toast { position:fixed; top:50px; right:12px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
        .toast-item { background:rgba(11,15,26,0.97); border:1px solid var(--primary); border-radius:16px; padding:12px 16px; min-width:240px; max-width:280px; pointer-events:all; animation:notifSlide 0.4s ease-out; box-shadow:0 0 20px rgba(0,255,247,0.2); }
        .toast-title { font-size:10px; font-weight:bold; color:var(--primary); font-family:'Orbitron',sans-serif; margin-bottom:4px; }
        .toast-body  { font-size:9px; color:#e2e8f0; line-height:1.4; }
        .toast-close { position:absolute; top:8px; right:10px; font-size:14px; color:#475569; cursor:pointer; background:none; border:none; }

        /* IMPRESI√ìN PROFESIONAL */
        @media print {
            body * { visibility: hidden; }
            #print-zone, #print-zone * { visibility: visible !important; }
            #print-zone { position: absolute; left: 0; top: 0; width: 100%; background: white !important; color: black !important; padding: 20px; }
            .glass-panel { border: 1px solid #ccc !important; background: white !important; color: black !important; }
            canvas { max-width: 100% !important; height: auto !important; page-break-inside: avoid; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="theme-Cyber font-normal">

    <!-- TOAST CONTAINER -->
    <div id="vico-toast"></div>

    <!-- TOP TASKBAR POMO -->
    <div id="top-taskbar" class="task-bar hidden">
        <div class="flex items-center gap-3 px-4 py-1 rounded-full bg-black/40 border border-white/5 shadow-inner">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_red]"></div>
            <span id="mini-timer" class="text-[11px] font-mono font-bold text-white tracking-widest">25:00</span>
            <span class="text-[8px] text-slate-500 uppercase font-bold tracking-tighter">Enfoque</span>
        </div>
    </div>

    <main id="main-scroll" class="h-screen w-full overflow-y-auto pt-10 pb-24 scroll-smooth">

        <!-- DASHBOARD -->
        <section id="view-dashboard" class="p-5 space-y-6 fade-in">
            <div class="p-6 rounded-3xl border border-blue-500/20 glass-panel bg-gradient-to-br from-blue-900/10 to-transparent text-center">
                <div class="logo-container" onmouseover="playSound('pulsar')">
                    <h1 class="text-3xl font-bold orbitron text-white">VICO POCKET DUVI</h1>
                    <div class="matrix-rain">1011010<br>VICO-OS<br>ELITE<br>0101101</div>
                </div>
                <p id="phrase" class="text-slate-500 italic text-[11px] mt-2">"Neural Bridge Established"</p>
            </div>

            <!-- KANBAN FLOW -->
            <div class="glass-panel p-5 rounded-3xl border-purple-500/20">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-bold orbitron text-purple-400 uppercase tracking-widest">Kanban Flow</h3>
                    <div class="flex gap-2">
                        <button onclick="window.print()" class="text-slate-500 p-1.5"><i data-lucide="printer" size="14"></i></button>
                        <button onclick="addKanbanTask()" class="bg-purple-600 p-1.5 rounded-lg text-white"><i data-lucide="plus" size="14"></i></button>
                    </div>
                </div>
                <div id="kanban-board" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    <div class="kanban-col" id="col-todo"><h4 class="text-[8px] font-bold mb-2 opacity-50">TODO</h4></div>
                    <div class="kanban-col" id="col-doing"><h4 class="text-[8px] font-bold mb-2 opacity-50">DOING</h4></div>
                    <div class="kanban-col" id="col-done"><h4 class="text-[8px] font-bold mb-2 opacity-50">DONE</h4></div>
                </div>
            </div>

            <!-- GRID ACCIONES -->
            <div class="grid grid-cols-3 gap-2">
                <div onclick="openNoteModal()" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer border-blue-500/30 transition-all active:scale-95">
                    <i data-lucide="plus-circle" class="text-blue-400 mb-1" size="20"></i><span class="text-[9px] font-bold">Nota</span>
                </div>
                <div onclick="switchTab('view-links')" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-white/5 transition-all active:scale-95">
                    <i data-lucide="bookmark" class="text-green-400 mb-1" size="20"></i><span class="text-[9px] font-bold">Links</span>
                </div>
                <div onclick="switchTab('view-calendar')" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-white/5 transition-all active:scale-95">
                    <i data-lucide="calendar" class="text-yellow-400 mb-1" size="20"></i><span id="dash-events-label" class="text-[9px] font-bold">Agenda</span>
                </div>
                <div onclick="openPomo()" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-white/5 transition-all active:scale-95">
                    <i data-lucide="zap" class="text-purple-400 mb-1" size="20"></i><span class="text-[9px] font-bold">Focus</span>
                </div>
                <div onclick="toggleThemeMode()" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-white/5 transition-all active:scale-95">
                    <i data-lucide="sun-moon" class="text-orange-400 mb-1" size="20"></i><span class="text-[9px] font-bold">Modo</span>
                </div>
                <div onclick="switchTab('view-analysis')" class="glass-panel p-3 rounded-xl flex flex-col items-center cursor-pointer hover:bg-white/5 transition-all active:scale-95">
                    <i data-lucide="activity" class="text-red-400 mb-1" size="20"></i><span class="text-[9px] font-bold">ROI</span>
                </div>
            </div>

            <div id="custom-buttons-dashboard" class="flex flex-wrap gap-2"></div>

            <div class="glass-panel p-5 rounded-3xl flex justify-around text-center border-white/5 shadow-inner">
                <div><div id="stat-notes" class="text-2xl font-bold text-white">0</div><div class="text-[8px] text-slate-500 uppercase tracking-widest">Notas</div></div>
                <div><div id="stat-links" class="text-2xl font-bold text-white">0</div><div class="text-[8px] text-slate-500 uppercase tracking-widest">Links</div></div>
                <div><div id="stat-tasks" class="text-2xl font-bold text-white">0</div><div class="text-[8px] text-slate-500 uppercase tracking-widest">Tasks</div></div>
            </div>

            <div id="install-banner" class="hidden p-4 glass-panel rounded-3xl border-blue-500/50 flex items-center justify-between animate-bounce">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-blue-600 rounded-xl"><i data-lucide="download-cloud" class="text-white"></i></div>
                    <div><h4 class="text-xs font-bold text-white">Instalar VICO POCKET</h4><p class="text-[9px] text-slate-400">Modo APK sin navegador</p></div>
                </div>
                <button onclick="triggerPwaInstall()" class="bg-blue-600 px-4 py-2 rounded-xl text-[10px] font-bold text-white">INSTALAR</button>
            </div>
        </section>

        <!-- NOTAS -->
        <section id="view-notes" class="hidden p-5 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold orbitron">Notas Pocket</h2>
                <div class="flex gap-2">
                    <button onclick="createNewFolder()" class="bg-slate-700 p-2.5 rounded-xl shadow-lg text-white"><i data-lucide="folder-plus"></i></button>
                    <button onclick="openNoteModal()" class="bg-blue-600 p-2.5 rounded-xl shadow-lg text-white"><i data-lucide="plus"></i></button>
                </div>
            </div>
            <div id="folder-bar" class="flex gap-2 overflow-x-auto no-scrollbar pb-6 border-b border-white/5 mb-6"></div>
            <div id="notes-grid" class="space-y-4"></div>
        </section>

        <!-- LINKS -->
        <section id="view-links" class="hidden p-5 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold orbitron">Links Pocket</h2>
                <button onclick="openLinkModal()" class="bg-green-600 p-2.5 rounded-xl shadow-lg text-white"><i data-lucide="plus"></i></button>
            </div>
            <div class="glass-panel p-4 rounded-xl mb-4 flex items-center gap-2">
                <i data-lucide="search" class="text-slate-500" size="16"></i>
                <input type="text" id="link-search" placeholder="Filtrar por etiquetas..." class="flex-1 bg-transparent border-none p-0 text-xs" oninput="renderLinks()">
            </div>
            <div id="links-list" class="space-y-3"></div>
        </section>

        <!-- DISCOVERY -->
        <section id="view-discovery" class="hidden p-5 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold orbitron">Discovery Elite</h2>
                <div class="flex gap-2">
                    <button onclick="fetchNews(app.activeRss)" class="text-blue-400 bg-blue-500/10 p-2 rounded-full"><i data-lucide="refresh-cw" size="18"></i></button>
                    <button onclick="openRssModal()" class="text-white bg-blue-600 p-2 rounded-full"><i data-lucide="plus" size="18"></i></button>
                </div>
            </div>
            <div id="discovery-chips" class="flex gap-2 overflow-x-auto no-scrollbar pb-4 mb-2"></div>
            <div id="news-list" class="space-y-6"></div>
        </section>

        <!-- AGENDA -->
        <section id="view-calendar" class="hidden p-5 fade-in pb-24">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold orbitron text-yellow-500">Agenda Pro</h2>
                <div class="flex gap-2">
                    <button onclick="requestNotifPermission()" id="btn-notif-perm" class="bg-yellow-800/40 border border-yellow-500/30 p-2.5 rounded-xl text-yellow-400 text-[9px] font-bold">üîî Activar</button>
                    <button onclick="openEventModal()" class="bg-yellow-600 p-2.5 rounded-xl text-white shadow-lg"><i data-lucide="plus"></i></button>
                </div>
            </div>
            <div id="notif-status-bar" class="hidden glass-panel p-3 rounded-xl mb-4 border-green-500/30 flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                <span class="text-[9px] text-green-400 font-bold">Notificaciones Android activadas ¬∑ Alertas en pantalla de bloqueo ON</span>
            </div>
            <div id="events-list" class="space-y-3 mb-6"></div>
            <div class="glass-panel p-4 rounded-2xl border-white/5">
                <h3 class="text-[9px] font-bold text-slate-500 uppercase mb-3">Historial de Notificaciones</h3>
                <div id="notif-history" class="space-y-2 max-h-40 overflow-y-auto no-scrollbar"></div>
                <button onclick="clearNotifHistory()" class="w-full mt-3 text-[8px] text-red-500 uppercase font-bold">Borrar Todo</button>
            </div>
        </section>

        <!-- AN√ÅLISIS ROI -->
        <section id="view-analysis" class="hidden p-5 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold orbitron text-purple-400 flex items-center gap-2"><i data-lucide="line-chart"></i> IA ROI Pro</h2>
                <button onclick="toggleMicrowave()" class="p-2 glass-panel rounded-xl text-cyan-400 border-cyan-500/30 hover:bg-cyan-500/10 transition-all">
                    <i data-lucide="layout-template"></i>
                </button>
            </div>

            <div class="glass-panel p-6 rounded-3xl mb-6 shadow-2xl border-purple-500/20">
                <textarea id="ai-query" placeholder="Ej: An√°lisis burs√°til Tesla vs BYD 2026, comparativa mercado EV Asia vs USA..." class="w-full h-24 text-sm mb-4 resize-none"></textarea>
                <div class="flex gap-2">
                    <button id="btn-ai" onclick="runROIAnalysis()" class="flex-1 bg-blue-600 py-3 rounded-2xl font-bold orbitron text-[10px] uppercase text-white shadow-lg">Analizar Prompt</button>
                    <label class="bg-slate-800 p-3 rounded-2xl cursor-pointer border border-white/5"><i data-lucide="file-up" class="text-purple-400"></i><input type="file" class="hidden" onchange="analyzeFile(this)"></label>
                </div>
            </div>

            <div id="vico-microwave" class="hidden glass-panel p-4 rounded-[32px] border-cyan-500/50 mb-6">
                <div class="flex gap-4">
                    <div class="microwave-door flex-1 h-32 rounded-2xl p-2 bg-black">
                        <div id="microwave-content" class="thinking-text"></div>
                    </div>
                    <div class="flex flex-col items-center justify-between py-2">
                        <div class="timer-knob" id="pomo-knob" style="--progress: 0deg;"></div>
                        <div class="text-[10px] font-mono text-cyan-400" id="micro-percent">0%</div>
                        <div class="w-2 h-2 rounded-full bg-red-600 animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- ZONA IMPRIMIBLE -->
            <div id="print-zone">
            <div id="ai-results" class="hidden space-y-6 pb-10">

                <!-- BOTONES ACCI√ìN -->
                <div class="flex gap-2 justify-end mb-4 no-print">
                    <button onclick="window.print()" class="bg-slate-800 p-2.5 rounded-xl border border-white/10 text-white flex items-center gap-2 text-[10px] font-bold">
                        <i data-lucide="printer" size="14"></i> IMPRIMIR
                    </button>
                    <button onclick="shareReport()" class="bg-blue-600 p-2.5 rounded-xl text-white flex items-center gap-2 text-[10px] font-bold shadow-lg">
                        <i data-lucide="share-2" size="14"></i> COMPARTIR
                    </button>
                </div>

                <!-- CABECERA INFORME -->
                <div class="glass-panel p-6 rounded-[32px] border-l-4 border-blue-500 shadow-2xl bg-black/40">
                    <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                        <span class="text-[10px] font-bold text-blue-400 uppercase tracking-[0.2em] orbitron">Resumen Ejecutivo VICO</span>
                        <span class="text-[9px] text-slate-500 font-mono" id="report-date"></span>
                    </div>
                    <div id="ai-report" class="text-[12px] leading-relaxed text-slate-200 font-mono whitespace-pre-wrap"></div>
                </div>

                <!-- KPIs DESTACADOS -->
                <div id="kpi-cards" class="grid grid-cols-2 gap-3"></div>

                <!-- GR√ÅFICO 1: L√çNEA TEMPORAL CON MESES REALES -->
                <div class="glass-panel p-4 rounded-3xl border-t-2 border-cyan-500/30">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="text-[9px] font-bold text-cyan-400 uppercase orbitron">Proyecci√≥n de Precio / Valor (12 meses)</h4>
                        <span id="chart-stock-label" class="text-[8px] text-slate-500 font-mono"></span>
                    </div>
                    <p id="chart-stock-desc" class="text-[8px] text-slate-600 mb-3"></p>
                    <div class="h-56"><canvas id="chartStock"></canvas></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- GR√ÅFICO 2: RADAR DE ATRIBUTOS REALES -->
                    <div class="glass-panel p-4 rounded-3xl">
                        <h4 class="text-[8px] font-bold text-slate-400 mb-1 uppercase orbitron">Atributos Clave</h4>
                        <p id="chart-radar-desc" class="text-[7px] text-slate-600 mb-2"></p>
                        <div class="h-40"><canvas id="chartRadarPro"></canvas></div>
                    </div>
                    <!-- GR√ÅFICO 3: DONUT CUOTA MERCADO -->
                    <div class="glass-panel p-4 rounded-3xl">
                        <h4 class="text-[8px] font-bold text-slate-400 mb-1 uppercase orbitron">Cuota de Mercado</h4>
                        <p id="chart-pie-desc" class="text-[7px] text-slate-600 mb-2"></p>
                        <div class="h-40"><canvas id="chartPiePro"></canvas></div>
                    </div>
                </div>

                <!-- GR√ÅFICO 4: BARRAS COMPARATIVAS CON PORCENTAJES -->
                <div class="glass-panel p-4 rounded-3xl border-t-2 border-blue-500/30">
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="text-[9px] font-bold text-blue-400 uppercase orbitron">Comparativa de Rendimiento Operativo</h4>
                        <span id="chart-bar-avg" class="text-[8px] text-slate-500 font-mono"></span>
                    </div>
                    <p id="chart-bar-desc" class="text-[8px] text-slate-600 mb-3"></p>
                    <div class="h-48"><canvas id="chartBarPro"></canvas></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- GR√ÅFICO 5: √ÅREA VARIANZA DE RIESGO -->
                    <div class="glass-panel p-4 rounded-3xl">
                        <h4 class="text-[8px] font-bold text-slate-400 mb-1 uppercase orbitron">Varianza de Riesgo</h4>
                        <p id="chart-area-desc" class="text-[7px] text-slate-600 mb-2"></p>
                        <div class="h-36"><canvas id="chartAreaPro"></canvas></div>
                    </div>
                    <!-- GR√ÅFICO 6: BARRAS HORIZONTALES IMPACTO -->
                    <div class="glass-panel p-4 rounded-3xl">
                        <h4 class="text-[8px] font-bold text-slate-400 mb-1 uppercase orbitron">Impacto Global %</h4>
                        <p id="chart-comp-desc" class="text-[7px] text-slate-600 mb-2"></p>
                        <div class="h-36"><canvas id="chartComparison"></canvas></div>
                    </div>
                </div>

                <!-- TABLA DE DATOS REALES -->
                <div class="glass-panel p-4 rounded-3xl border-t-2 border-purple-500/30">
                    <h4 class="text-[9px] font-bold text-purple-400 mb-3 uppercase orbitron">Tabla de Datos ¬∑ M√©tricas Detalladas</h4>
                    <div class="overflow-x-auto no-scrollbar">
                        <table id="data-table" class="w-full text-[9px]">
                            <thead><tr id="table-head" class="border-b border-white/10"></tr></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- FOOTER INFORME -->
                <div class="glass-panel p-4 rounded-2xl border-white/5 text-center">
                    <p class="text-[8px] text-slate-600 font-mono">Informe generado por VICO POCKET OS v14 ¬∑ <span id="footer-date"></span></p>
                    <p class="text-[7px] text-slate-700 mt-1">Los datos son proyecciones de IA y no constituyen asesoramiento financiero.</p>
                </div>

            </div><!-- /ai-results -->
            </div><!-- /print-zone -->
        </section>

        <!-- PERFIL / CORE -->
        <section id="view-profile" class="hidden p-5 fade-in pb-24">
            <h2 class="text-2xl font-bold orbitron mb-6 text-slate-300">VICO Core</h2>
            <div class="space-y-6">

                <div class="glass-panel p-5 rounded-3xl border-blue-500/20">
                    <h3 class="text-[10px] font-bold text-blue-400 uppercase mb-4 tracking-widest">Motor Neural & API</h3>
                    <div class="flex gap-2">
                        <input type="password" id="api-key-input" placeholder="API Key (Gemini o Groq)..." class="flex-1 text-xs font-mono">
                        <button onclick="saveApi()" class="bg-green-600 px-4 rounded-xl font-bold text-xs text-white shadow-lg">SAVE</button>
                    </div>
                </div>

                <div class="glass-panel p-5 rounded-3xl">
                    <h3 class="text-[10px] font-bold text-white uppercase mb-4">Inyector de Botones (URL)</h3>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <input type="text" id="btn-name" placeholder="Etiqueta" class="text-xs">
                        <input type="text" id="btn-url" placeholder="https://..." class="text-xs">
                    </div>
                    <button onclick="createCustomBtn()" class="w-full bg-blue-600 py-3 rounded-xl font-bold text-xs text-white shadow-lg">Inyectar en Dashboard</button>
                </div>

                <div class="glass-panel p-5 rounded-3xl" id="system-box">
                    <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4">Configuraci√≥n OS</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Tema Visual</span><select id="sys-theme" onchange="updateSystem('theme',this.value)" class="text-[10px] py-1 px-4"><option value="Cyber">Cyber Blue</option><option value="Gold">Luxury Gold</option><option value="Nature">Nature Green</option><option value="Nebula">Nebula</option><option value="Minimal">Black Minimal</option></select></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Tama√±o Texto</span><select id="sys-font" onchange="updateSystem('font',this.value)" class="text-[10px] py-1 px-4"><option value="font-sm">Peque√±o</option><option value="font-normal">Normal</option><option value="font-lg">Grande</option></select></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Idioma</span><select id="sys-lang" onchange="updateSystem('lang',this.value)" class="text-[10px] py-1 px-4"><option value="es">Espa√±ol</option><option value="en">English</option><option value="zh">‰∏≠Êñá</option></select></div>
                        <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Pop-ups</span><input type="checkbox" id="sys-popup" onchange="updateSystem('showPopup',this.checked)" class="w-5 h-5 accent-green-600"></div>
                    </div>
                </div>

                <div class="glass-panel p-5 rounded-3xl border-orange-500/30 space-y-4">
                    <h3 class="text-[10px] font-bold text-orange-400 uppercase tracking-widest">Data Vault & Sync</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportOSData()" class="bg-green-600/20 border border-green-500/50 py-2 rounded-xl text-[9px] font-bold text-green-400 uppercase flex items-center justify-center gap-1"><i data-lucide="download" size="12"></i> Exportar</button>
                        <button onclick="document.getElementById('import-file').click()" class="bg-blue-600/20 border border-blue-500/50 py-2 rounded-xl text-[9px] font-bold text-blue-400 uppercase flex items-center justify-center gap-1"><i data-lucide="upload" size="12"></i> Importar</button>
                        <input type="file" id="import-file" class="hidden" onchange="importOSData(this)">
                    </div>
                    <div class="flex justify-between items-center border-t border-white/5 pt-3"><span class="text-[10px] text-slate-400 uppercase font-bold">Notificaciones Android</span><input type="checkbox" id="sys-notify" onchange="updateSystem('notifications',this.checked)" class="w-5 h-5 accent-green-600"></div>
                    <div class="flex justify-between items-center"><span class="text-[10px] text-slate-400 uppercase font-bold">Sonidos UI</span><input type="checkbox" id="sys-ui-sounds" onchange="updateSystem('uiSounds',this.checked)" class="w-5 h-5 accent-blue-600"></div>
                    <div>
                        <h4 class="text-[9px] font-bold text-blue-400 mb-2">Alertas RSS Individuales</h4>
                        <div id="rss-notify-controls" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"></div>
                    </div>
                    <button onclick="forceSystemUpdate()" class="w-full bg-orange-600/20 border border-orange-500/50 py-3 rounded-xl font-bold text-xs text-orange-400 uppercase shadow-lg active:scale-95 transition-all">Limpiar Cach√© N√∫cleo</button>
                </div>

                <div class="glass-panel p-5 rounded-3xl text-center border-white/5 shadow-inner">
                    <p class="text-[9px] text-slate-500 mb-2">VICO POCKET OS - ELITE v13 ¬∑ Local-First</p>
                    <p class="font-bold text-blue-400 flex items-center justify-center gap-2 mb-3">
                        <i data-lucide="linkedin" size="12"></i>
                        <a href="https://www.linkedin.com/in/jaime-andr√©s-due√±as-vicu√±a" target="_blank" class="underline text-[10px]">Jaime Andr√©s Due√±as Vicu√±a</a>
                    </p>
                    <a href="https://www.paypal.com/paypalme/proyectosduvi" target="_blank" class="inline-flex items-center gap-2 bg-[#0070ba] px-6 py-2 rounded-full font-bold text-[10px] text-white shadow-lg"><i data-lucide="coffee" size="14"></i> PayPal Support</a>
                </div>
            </div>
        </section>

    </main>

    <!-- NAV BAR -->
    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('view-dashboard',this)"><i data-lucide="home"></i><span>HOME</span></div>
        <div class="nav-item" onclick="switchTab('view-notes',this)"><i data-lucide="file-text"></i><span>DATA</span></div>
        <div class="nav-item" onclick="switchTab('view-links',this)"><i data-lucide="bookmark"></i><span>LINKS</span></div>
        <div class="nav-item" onclick="switchTab('view-analysis',this)"><i data-lucide="pie-chart"></i><span>ROI</span></div>
        <div class="nav-item" onclick="switchTab('view-discovery',this)"><i data-lucide="compass"></i><span>FEEDS</span></div>
        <div class="nav-item" onclick="switchTab('view-calendar',this)"><i data-lucide="calendar"></i><span>AGENDA</span></div>
        <div class="nav-item" onclick="switchTab('view-profile',this)"><i data-lucide="user"></i><span>CORE</span></div>
    </nav>

    <!-- MODAL ALARMA -->
    <div id="modal-alarm" class="fixed inset-0 z-[1000] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-[40px] p-8 text-center border-red-500/50 alarm-active">
            <div class="w-20 h-20 bg-red-600/20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_50px_red]"><i data-lucide="bell-ring" class="text-red-500 animate-bounce" size="40"></i></div>
            <h2 class="orbitron text-2xl font-bold text-white mb-2 uppercase">VICO AGENDA</h2>
            <p id="alarm-title" class="text-slate-300 text-sm mb-8 font-bold tracking-widest uppercase"></p>
            <button onclick="stopAlarm()" class="w-full bg-red-600 py-4 rounded-2xl font-bold text-white shadow-lg tracking-[0.2em] active:scale-95">DETENER ALARMA</button>
        </div>
    </div>

    <!-- CHAT VICO AI -->
    <div id="vico-chat" class="fixed bottom-24 right-4 z-[150]">
        <button onclick="toggleChat()" class="bg-blue-600 p-4 rounded-full shadow-2xl transition-all border border-white/10 hover:scale-110 active:scale-90"><i data-lucide="bot" class="text-white"></i></button>
        <div id="chat-win" class="glass-panel fixed bottom-44 right-4 w-80 h-[450px] rounded-3xl flex flex-col hidden overflow-hidden shadow-2xl border-blue-500/20">
            <div class="bg-blue-600 p-4 flex justify-center items-center text-white text-[10px] font-bold uppercase tracking-widest">VICO AI ASSISTANT</div>
            <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 space-y-4 text-[11px] leading-relaxed">
                <div class="bg-white/5 p-3 rounded-2xl mr-10 border border-white/5">VICO v14: Enlace neural activo. ¬øQu√© analizamos hoy?</div>
            </div>
            <div class="p-3 border-t border-white/5 flex gap-1">
                <input type="text" id="chat-in" placeholder="..." class="flex-1 p-2.5 text-[10px] bg-black/40 border-none rounded-lg" onkeydown="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()" class="bg-blue-600 p-2.5 rounded-xl"><i data-lucide="send" size="14"></i></button>
            </div>
        </div>
    </div>

    <!-- MODAL NOTA -->
    <div id="modal-note" class="fixed inset-0 z-[600] bg-black/90 backdrop-blur flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4 border-blue-500/30 shadow-2xl">
            <h3 class="font-bold orbitron text-blue-400 text-sm uppercase">Registro Neural</h3>
            <input type="hidden" id="nt-id">
            <input type="text" id="nt-title" placeholder="T√≠tulo..." class="w-full text-sm">
            <div class="flex gap-2">
                <select id="nt-folder-modal" class="flex-1 text-[10px] font-bold text-blue-400"></select>
                <input type="color" id="nt-color" value="#3b82f6" class="w-10 h-10 border-none bg-transparent cursor-pointer">
            </div>
            <textarea id="nt-text" placeholder="Contenido neural..." class="w-full h-40 text-xs resize-none"></textarea>
            <div class="flex gap-2 pt-2">
                <button onclick="saveNote()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-white shadow-lg active:scale-95">SAVE</button>
                <button onclick="closeModal('modal-note')" class="flex-1 glass-panel py-3 rounded-xl text-xs">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- MODAL LINK -->
    <div id="modal-link" class="fixed inset-0 z-[600] bg-black/90 backdrop-blur flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4 border-green-500/30 shadow-2xl">
            <h3 class="font-bold orbitron text-green-400 text-sm uppercase">Guardar Enlace</h3>
            <input type="text" id="lk-url" placeholder="https://..." class="w-full text-sm">
            <input type="text" id="lk-title" placeholder="T√≠tulo" class="w-full text-sm">
            <input type="text" id="lk-tags" placeholder="Etiquetas (separadas por comas)" class="w-full text-sm">
            <div class="flex gap-2 pt-2">
                <button onclick="saveLink()" class="flex-1 bg-green-600 py-3 rounded-xl font-bold text-white active:scale-95">SAVE</button>
                <button onclick="closeModal('modal-link')" class="flex-1 glass-panel py-3 rounded-xl text-xs">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- MODAL EVENTO -->
    <div id="modal-event" class="fixed inset-0 z-[600] bg-black/90 backdrop-blur flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4 border-yellow-500/30 shadow-2xl">
            <h3 class="font-bold orbitron text-yellow-400 text-sm uppercase">Agendar Cita</h3>
            <input type="text" id="ev-title" placeholder="Descripci√≥n de la cita..." class="w-full text-sm">
            <input type="datetime-local" id="ev-date" class="w-full text-sm">
            <button onclick="saveEvent()" class="w-full bg-yellow-600 py-3 rounded-xl font-bold text-white shadow-lg uppercase text-xs active:scale-95">Confirmar</button>
            <button onclick="closeModal('modal-event')" class="w-full text-[10px] text-slate-500 uppercase tracking-widest">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL POMO -->
    <div id="modal-pomo" class="fixed inset-0 z-[600] bg-black/98 backdrop-blur flex items-center justify-center hidden">
        <div class="text-center space-y-8">
            <div id="pomo-clock" class="text-8xl orbitron font-bold text-white">25:00</div>
            <div class="flex justify-center gap-6">
                <button onclick="toggleFocus()" id="pomo-ctrl" class="bg-blue-600 p-8 rounded-full shadow-2xl active:scale-90"><i data-lucide="play" fill="white"></i></button>
                <button onclick="resetFocus()" class="glass-panel p-8 rounded-full active:scale-90"><i data-lucide="rotate-ccw"></i></button>
            </div>
            <button onclick="minimizePomo()" class="text-slate-500 uppercase text-[10px] underline tracking-[0.2em]">MINIMIZAR</button>
        </div>
    </div>

    <!-- MODAL RSS -->
    <div id="modal-rss" class="fixed inset-0 z-[600] bg-black/90 flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4 border-orange-500/30 shadow-2xl">
            <h3 class="font-bold orbitron text-orange-400 text-sm uppercase">Nuevo Feed RSS</h3>
            <input type="text" id="new-rss-name" placeholder="Nombre del feed" class="w-full text-sm">
            <input type="text" id="new-rss-url" placeholder="URL del feed" class="w-full text-sm">
            <button onclick="addNewRss()" class="w-full bg-orange-600 py-3 rounded-xl font-bold text-white active:scale-95">A√±adir</button>
            <button onclick="closeModal('modal-rss')" class="w-full text-[10px] text-slate-500">CANCELAR</button>
        </div>
    </div>

    <!-- MODAL KANBAN -->
    <div id="modal-kanban" class="fixed inset-0 z-[600] bg-black/90 backdrop-blur flex items-center justify-center p-6 hidden">
        <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4 border-purple-500/30 shadow-2xl">
            <h3 class="font-bold orbitron text-purple-400 text-sm uppercase">Nueva Tarea Kanban</h3>
            <input type="text" id="kb-task" placeholder="Describe la tarea..." class="w-full text-sm">
            <select id="kb-col" class="w-full text-sm">
                <option value="todo">TODO</option>
                <option value="doing">DOING</option>
                <option value="done">DONE</option>
            </select>
            <button onclick="saveKanbanTask()" class="w-full bg-purple-600 py-3 rounded-xl font-bold text-white active:scale-95">A√ëADIR TAREA</button>
            <button onclick="closeModal('modal-kanban')" class="w-full text-[10px] text-slate-500">CANCELAR</button>
        </div>
    </div>

    <script>
    // ==========================================
    // üõ°Ô∏è PROTOCOLO DE BLINDAJE DUVI
    // ==========================================
    setInterval(() => {
        const s = Date.now(); debugger;
        if (Date.now() - s > 100) {
            document.body.innerHTML = "<div style='color:red;text-align:center;padding-top:20%;font-family:monospace;font-size:2rem'>VIOLACI√ìN DE N√öCLEO DETECTADA</div>";
        }
    }, 1000);

    // ==========================================
    // üß† ESTADO GLOBAL
    // ==========================================
    let app = {
        notes:        JSON.parse(localStorage.getItem('vp_notes'))      || [],
        events:       JSON.parse(localStorage.getItem('vp_events'))     || [],
        links:        JSON.parse(localStorage.getItem('vp_links'))      || [],
        btns:         JSON.parse(localStorage.getItem('vp_btns'))       || [],
        kanban:       JSON.parse(localStorage.getItem('vp_kanban'))     || [],
        notifHistory: JSON.parse(localStorage.getItem('vp_notif_hist')) || [],
        rss: JSON.parse(localStorage.getItem('vp_rss')) || [
            {name:'The Verge',      url:'https://www.theverge.com/rss/index.xml',              notify:true},
            {name:'MIT News',       url:'https://news.mit.edu/rss/feed',                       notify:true},
            {name:'TechCrunch',     url:'https://techcrunch.com/feed/',                        notify:true},
            {name:'Nature',         url:'https://www.nature.com/nature/articles?type=rss',     notify:false},
            {name:'El Mundo',       url:'https://e00-elmundo.uecdn.es/rss/portada.xml',        notify:false},
            {name:'CNN',            url:'http://rss.cnn.com/rss/cnn_topstories.rss',           notify:false},
            {name:'Infobae',        url:'https://www.infobae.com/feeds/rss/',                  notify:false},
            {name:'Ecoinventos',    url:'https://ecoinventos.com/feed/',                       notify:false},
            {name:'Computer Hoy',   url:'https://computerhoy.com/rss.xml',                    notify:false},
            {name:'WIRED',          url:'https://www.wired.com/feed/rss',                      notify:false},
            {name:'MIT Tech Review',url:'https://www.technologyreview.com/feed/',              notify:false}
        ],
        config: JSON.parse(localStorage.getItem('vp_config')) || {
            key:'', theme:'Cyber', font:'font-normal',
            uiSounds:true, notifications:false, lang:'es',
            showPopup:true, mode:'dark'
        },
        pomo:        { time:1500, active:false, timer:null },
        folders:     JSON.parse(localStorage.getItem('vp_folders')) || ["Fijadas","Resumen","Proyectos","C√≥digo","Links","Varios"],
        activeFolder:'Fijadas',
        activeRss:   0,
        notified:    [],
        alarmInterval: null
    };

    // ==========================================
    // üíæ PERSISTENCIA
    // ==========================================
    function save() {
        localStorage.setItem('vp_notes',      JSON.stringify(app.notes));
        localStorage.setItem('vp_events',     JSON.stringify(app.events));
        localStorage.setItem('vp_links',      JSON.stringify(app.links));
        localStorage.setItem('vp_config',     JSON.stringify(app.config));
        localStorage.setItem('vp_btns',       JSON.stringify(app.btns));
        localStorage.setItem('vp_rss',        JSON.stringify(app.rss));
        localStorage.setItem('vp_folders',    JSON.stringify(app.folders));
        localStorage.setItem('vp_kanban',     JSON.stringify(app.kanban));
        localStorage.setItem('vp_notif_hist', JSON.stringify(app.notifHistory));
    }

    // ==========================================
    // üîä AUDIO
    // ==========================================
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if (!app.config.uiSounds) return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        if      (type==='pulsar') { o.frequency.setValueAtTime(400,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.15); }
        else if (type==='siren')  { o.frequency.setValueAtTime(800,audioCtx.currentTime); o.frequency.linearRampToValueAtTime(1400,audioCtx.currentTime+0.4); }
        else if (type==='zen')    { o.frequency.setValueAtTime(500,audioCtx.currentTime); o.frequency.linearRampToValueAtTime(800,audioCtx.currentTime+1); }
        else                      { o.frequency.value = parseInt(type) || 800; }
        g.gain.value = 0.05; o.start(); o.stop(audioCtx.currentTime + 0.5);
    }

    // ==========================================
    // üîî NOTIFICACIONES NATIVAS ANDROID (REAL)
    // ==========================================

    // Solicitar permiso expl√≠citamente al pulsar el bot√≥n en Agenda
    async function requestNotifPermission() {
        if (!('Notification' in window)) {
            showToast('VICO OS', 'Tu navegador no soporta notificaciones nativas.', 4000);
            return;
        }
        try {
            // En Android Chrome la solicitud DEBE venir de un gesto del usuario
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                app.config.notifications = true;
                save();
                document.getElementById('sys-notify').checked = true;
                document.getElementById('notif-status-bar').classList.remove('hidden');
                document.getElementById('btn-notif-perm').innerText = '‚úÖ Activas';
                // Test inmediato para que Android indexe el canal
                await sendNativeNotif('‚úÖ VICO POCKET OS', 'Alertas activadas. Recibir√°s avisos en pantalla de bloqueo.');
                showToast('‚úÖ Notificaciones ON', 'Las alertas de Agenda aparecer√°n en la pantalla de bloqueo Android.', 5000);
            } else {
                showToast('‚ö†Ô∏è Permiso denegado', 'Ve a Ajustes del navegador ‚Üí Notificaciones y act√≠valas para esta app.', 7000);
            }
        } catch(e) {
            showToast('Error', e.message, 4000);
        }
    }

    // Enviar notificaci√≥n nativa real que aparece en pantalla de bloqueo Android
    async function sendNativeNotif(title, body) {
        if (!('Notification' in window) || Notification.permission !== 'granted') return;

        // Intentar via Service Worker (la √∫nica forma real de aparecer en pantalla de bloqueo)
        if ('serviceWorker' in navigator) {
            try {
                const reg = await navigator.serviceWorker.ready;
                // showNotification del SW = notificaci√≥n persistente en Android
                await reg.showNotification(title, {
                    body:               body,
                    icon:               './icon.png',
                    badge:              './icon.png',
                    tag:                'vico-agenda-' + Date.now(),
                    renotify:           true,          // Vibrar aunque el tag sea igual
                    requireInteraction: true,           // NO se descarta sola en Android
                    silent:             false,
                    vibrate:            [400, 100, 400, 100, 800], // Patr√≥n vibraci√≥n VICO
                    data: {
                        url:  window.location.href,    // El SW lo usar√° en notificationclick
                        time: Date.now()
                    },
                    // Acciones r√°pidas en la notificaci√≥n (Android 8+)
                    actions: [
                        { action: 'open',   title: 'üìÖ Ver Agenda' },
                        { action: 'dismiss', title: '‚úì Entendido' }
                    ]
                });
                return; // √âxito via SW
            } catch(swErr) {
                console.warn('VICO: SW notification failed, usando fallback:', swErr);
            }
        }

        // Fallback: Notification API directa (solo funciona con la app en primer plano)
        try {
            const n = new Notification(title, {
                body,
                icon:               './icon.png',
                tag:                'vico-fallback-' + Date.now(),
                requireInteraction: true,
                silent:             false
            });
            n.onclick = () => { window.focus(); n.close(); };
        } catch(e) {
            console.warn('VICO: Notification API fallback failed:', e);
        }
    }

    // Toast visual in-app (siempre visible aunque no haya permiso nativo)
    function showToast(title, body, duration=4000) {
        const container = document.getElementById('vico-toast');
        const id = 'toast-' + Date.now();
        const el = document.createElement('div');
        el.id = id;
        el.className = 'toast-item';
        el.innerHTML = `
            <button class="toast-close" onclick="document.getElementById('${id}').remove()">√ó</button>
            <div class="toast-title">${title}</div>
            <div class="toast-body">${body}</div>`;
        container.appendChild(el);
        setTimeout(() => { if(document.getElementById(id)) document.getElementById(id).remove(); }, duration);
    }

    // ==========================================
    // üö® ALARMA (IN-APP + NATIVA ANDROID)
    // ==========================================
    function triggerAlarm(title) {
        // 1. Modal in-app
        document.getElementById('alarm-title').innerText = title;
        document.getElementById('modal-alarm').classList.remove('hidden');
        if (app.alarmInterval) clearInterval(app.alarmInterval);
        app.alarmInterval = setInterval(() => playSound('800'), 800);

        // 2. Toast in-app (visible aunque el modal est√© minimizado)
        showToast('üîî AGENDA VICO', title, 10000);

        // 3. Notificaci√≥n nativa Android (pantalla de bloqueo)
        sendNativeNotif('üìÖ VICO AGENDA', title);

        // Historial
        app.notifHistory.unshift({ title, time: new Date().toLocaleString() });
        if (app.notifHistory.length > 50) app.notifHistory.pop();
        save(); renderNotifHistory();
    }

    function stopAlarm() {
        clearInterval(app.alarmInterval);
        document.getElementById('modal-alarm').classList.add('hidden');
    }

    // ==========================================
    // ‚öôÔ∏è SISTEMA
    // ==========================================
    function applySystemConfig() {
        const cfg = app.config;
        let classes = `theme-${cfg.theme} ${cfg.font}`;
        if (cfg.mode === 'light') classes += ' mode-light';
        document.body.className = classes;

        const setVal = (id,v) => { const e=document.getElementById(id); if(e) e.value=v; };
        const setChk = (id,v) => { const e=document.getElementById(id); if(e) e.checked=v; };
        setVal('sys-theme', cfg.theme);
        setVal('sys-font',  cfg.font);
        setVal('sys-lang',  cfg.lang);
        setVal('api-key-input', cfg.key);
        setChk('sys-popup',    cfg.showPopup);
        setChk('sys-notify',   cfg.notifications);
        setChk('sys-ui-sounds',cfg.uiSounds);

        const folderSel = document.getElementById('nt-folder-modal');
        if (folderSel) folderSel.innerHTML = app.folders.map(f=>`<option value="${f}">${f}</option>`).join('');

        // Mostrar estado de notificaciones
        if (cfg.notifications && Notification.permission === 'granted') {
            const bar = document.getElementById('notif-status-bar');
            const btn = document.getElementById('btn-notif-perm');
            if (bar) bar.classList.remove('hidden');
            if (btn) btn.innerText = '‚úÖ Activas';
        }
    }

    function updateSystem(k,v) { app.config[k]=v; save(); applySystemConfig(); playSound(800); }
    function saveApi() { app.config.key=document.getElementById('api-key-input').value.trim(); save(); alert('VICO: API Sincronizada.'); playSound(1000); }
    function toggleThemeMode() { app.config.mode = app.config.mode==='light'?'dark':'light'; save(); applySystemConfig(); playSound(600); }

    // ==========================================
    // üìã KANBAN
    // ==========================================
    function addKanbanTask() { document.getElementById('modal-kanban').classList.remove('hidden'); }
    function saveKanbanTask() {
        const task = document.getElementById('kb-task').value.trim();
        const col  = document.getElementById('kb-col').value;
        if (!task) return;
        app.kanban.push({ id:Date.now().toString(), text:task, status:col });
        document.getElementById('kb-task').value = '';
        save(); renderKanban(); closeModal('modal-kanban'); playSound(800);
    }
    function renderKanban() {
        ['todo','doing','done'].forEach(col => {
            const el = document.getElementById(`col-${col}`); if(!el) return;
            const tasks = app.kanban.filter(t=>t.status===col);
            el.innerHTML = `<h4 class="text-[8px] font-bold mb-2 opacity-50 uppercase">${col}</h4>`;
            tasks.forEach(t => {
                el.innerHTML += `<div class="kanban-card group"><span class="text-[10px]">${t.text}</span><button onclick="delKanban('${t.id}')" class="absolute right-1 top-1 opacity-0 group-hover:opacity-100 text-red-500 text-xs font-bold leading-none">√ó</button></div>`;
            });
        });
        const s = document.getElementById('stat-tasks'); if(s) s.innerText = app.kanban.length;
    }
    function delKanban(id) { app.kanban=app.kanban.filter(t=>t.id!==id); save(); renderKanban(); }

    // ==========================================
    // üìù NOTAS
    // ==========================================
    function renderNotes() {
        const bar = document.getElementById('folder-bar');
        bar.innerHTML = app.folders.map(f =>
            `<button onclick="setFolder('${f}')" class="px-5 py-2 rounded-full text-[10px] font-bold whitespace-nowrap transition-all ${app.activeFolder===f?'chip-active':'bg-slate-800 text-slate-500'}">${f}</button>`
        ).join('');
        const grid = document.getElementById('notes-grid');
        grid.innerHTML = app.notes.filter(n=>n.folder===app.activeFolder).map(n => `
            <div class="glass-panel p-5 rounded-3xl border-l-8 shadow-xl fade-in" style="border-left-color:${n.color||'var(--primary)'}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1" onclick="openNoteModal('${n.id}')">
                        <h4 class="font-bold text-sm text-white">${n.title}</h4>
                        <p class="text-[10px] text-slate-400 mt-2 line-clamp-3 leading-relaxed">${n.content}</p>
                    </div>
                    <button onclick="delNote('${n.id}')" class="text-slate-600 hover:text-red-400 p-2"><i data-lucide="trash-2" size="14"></i></button>
                </div>
                <div class="flex justify-between items-center bg-black/30 p-2 rounded-xl border border-white/5">
                    <select onchange="moveNote('${n.id}',this.value)" class="text-[8px] bg-transparent border-none p-0 outline-none text-blue-400 font-bold appearance-none">
                        ${app.folders.map(f=>`<option value="${f}" ${n.folder===f?'selected':''}>${f}</option>`).join('')}
                    </select>
                    <span class="text-[8px] text-slate-600 font-mono">${n.date}</span>
                </div>
            </div>`).join('') || '<p class="text-center py-20 text-slate-800 text-xs">Vac√≠o</p>';
        lucide.createIcons();
    }
    function setFolder(f) { app.activeFolder=f; renderNotes(); playSound(600); }
    function moveNote(id,f) { const i=app.notes.findIndex(n=>n.id===id); app.notes[i].folder=f; save(); renderNotes(); }
    function delNote(id)  { app.notes=app.notes.filter(n=>n.id!==id); save(); renderNotes(); renderDashboard(); }
    function openNoteModal(id=null) {
        playSound(400); document.getElementById('modal-note').classList.remove('hidden');
        if (id) {
            const n=app.notes.find(x=>x.id===id);
            document.getElementById('nt-id').value=n.id; document.getElementById('nt-title').value=n.title;
            document.getElementById('nt-text').value=n.content; document.getElementById('nt-folder-modal').value=n.folder;
            document.getElementById('nt-color').value=n.color||'#3b82f6';
        } else {
            ['nt-id','nt-title','nt-text'].forEach(x=>document.getElementById(x).value='');
        }
    }
    function saveNote() {
        const id=document.getElementById('nt-id').value, title=document.getElementById('nt-title').value.trim(),
              content=document.getElementById('nt-text').value.trim(), folder=document.getElementById('nt-folder-modal').value,
              color=document.getElementById('nt-color').value;
        if (!title||!content) return alert("Completa los campos.");
        if (id) { const i=app.notes.findIndex(n=>n.id===id); app.notes[i]={...app.notes[i],title,content,folder,color}; }
        else { app.notes.unshift({id:Date.now().toString(),title,content,folder,color,date:new Date().toLocaleDateString()}); }
        save(); renderNotes(); renderDashboard(); closeModal('modal-note'); playSound(800);
    }
    function createNewFolder() {
        const name=prompt("Nombre de la nueva categor√≠a:");
        if (name&&!app.folders.includes(name)) { app.folders.push(name); save(); renderNotes(); applySystemConfig(); }
    }

    // ==========================================
    // üîó LINKS
    // ==========================================
    function saveLink() {
        const u=document.getElementById('lk-url').value.trim(), t=document.getElementById('lk-title').value.trim(),
              tags=document.getElementById('lk-tags').value;
        if (!u) return;
        app.links.unshift({id:Date.now().toString(), url:u.startsWith('http')?u:'https://'+u, title:t||u, tags:tags.split(',').map(s=>s.trim()).filter(s=>s)});
        save(); renderLinks(); renderDashboard(); closeModal('modal-link');
        ['lk-url','lk-title','lk-tags'].forEach(id=>document.getElementById(id).value='');
    }
    function renderLinks() {
        const q=document.getElementById('link-search').value.toLowerCase();
        const list=document.getElementById('links-list');
        list.innerHTML = app.links.filter(l=>l.title.toLowerCase().includes(q)||l.url.toLowerCase().includes(q)||(l.tags||[]).join(' ').toLowerCase().includes(q)).map(l => {
            let domain='#'; try{domain=new URL(l.url).hostname;}catch(e){}
            return `
            <div class="glass-panel p-4 rounded-[28px] flex gap-4 items-center border-l-2 border-green-500/30 fade-in">
                <div class="w-14 h-14 rounded-2xl bg-black/40 p-2 flex items-center justify-center shadow-inner border border-white/5">
                    <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=128" class="w-full h-full object-contain rounded-lg" onerror="this.style.display='none'">
                </div>
                <div class="flex-1 truncate">
                    <a href="${l.url}" target="_blank" class="text-sm font-bold text-blue-400 block truncate hover:underline">${l.title}</a>
                    <p class="text-[9px] text-slate-500 font-mono truncate mt-1 italic">${l.url}</p>
                    ${l.tags&&l.tags.length?`<div class="flex gap-1 mt-1 flex-wrap">${l.tags.map(tag=>`<span class="text-[7px] bg-white/5 px-2 py-0.5 rounded-full text-slate-400">${tag}</span>`).join('')}</div>`:''}
                </div>
                <button onclick="delLink('${l.id}')" class="text-slate-700 hover:text-red-400 p-2"><i data-lucide="trash-2" size="14"></i></button>
            </div>`;
        }).join('')||'<p class="text-center py-20 text-slate-700 text-xs">Memory Card Vac√≠a.</p>';
        lucide.createIcons();
    }
    function delLink(id) { app.links=app.links.filter(l=>l.id!==id); save(); renderLinks(); renderDashboard(); }
    function saveLinkToPocket(u,t) { app.links.unshift({id:Date.now().toString(),url:u,title:t,tags:['Discovery']}); save(); renderLinks(); renderDashboard(); playSound(1000); alert("Link guardado."); }
    function shareLink(u) { if(navigator.share) navigator.share({url:u}); else prompt("Link:",u); }

    // ==========================================
    // üìÖ AGENDA & EVENTOS
    // ==========================================
    function saveEvent() {
        const t=document.getElementById('ev-title').value.trim(), d=document.getElementById('ev-date').value;
        if (!t||!d) return;
        app.events.push({id:Date.now().toString(),title:t,date:d});
        save(); renderEvents(); renderDashboard(); closeModal('modal-event'); playSound(800);
        showToast('üìÖ Evento creado', `"${t}" guardado en agenda.`, 3000);
    }
    function renderEvents() {
        const el=document.getElementById('events-list');
        el.innerHTML = app.events.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(e => `
            <div class="glass-panel p-4 rounded-xl border-l-4 border-yellow-500 flex justify-between items-center">
                <div>
                    <div class="text-xs font-bold text-white">${e.title}</div>
                    <div class="text-[9px] text-slate-500">${new Date(e.date).toLocaleString()}</div>
                </div>
                <button onclick="delEvent('${e.id}')" class="text-slate-700 hover:text-red-400 p-2"><i data-lucide="trash-2" size="16"></i></button>
            </div>`).join('')||'<p class="text-center text-xs text-slate-600 py-10">Agenda Vac√≠a</p>';
        lucide.createIcons();
    }
    function delEvent(id) { app.events=app.events.filter(e=>e.id!==id); save(); renderEvents(); renderDashboard(); }

    function checkAgenda() {
        const now = new Date();
        app.events.forEach(e => {
            const evDate = new Date(e.date);
            // Ventana de 90 segundos para no perder la alarma entre checks de 20s
            if (Math.abs(now - evDate) < 90000 && !app.notified.includes(e.id)) {
                app.notified.push(e.id);
                triggerAlarm(e.title);
            }
        });
    }

    function renderNotifHistory() {
        const el=document.getElementById('notif-history'); if(!el) return;
        el.innerHTML = app.notifHistory.map(n => `
            <div class="text-[9px] bg-white/5 p-2 rounded-xl flex justify-between items-center">
                <span class="text-slate-300 font-bold truncate flex-1">${n.title}</span>
                <span class="text-slate-600 font-mono ml-2 flex-shrink-0">${n.time}</span>
            </div>`).join('')||'<p class="text-[9px] text-slate-600">Sin historial</p>';
    }
    function clearNotifHistory() { app.notifHistory=[]; save(); renderNotifHistory(); }

    // ==========================================
    // üì° RSS / DISCOVERY
    // ==========================================
    async function fetchNews(idx=0) {
        app.activeRss=idx; renderChips();
        const list=document.getElementById('news-list');
        list.innerHTML='<div class="py-20 text-center animate-pulse text-slate-500 text-xs">Cargando feed...</div>';
        try {
            const res=await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(app.rss[idx].url)}`);
            const data=await res.json();
            if (!data.items||!data.items.length) throw new Error();
            list.innerHTML = data.items.map(item => {
                const img=item.thumbnail||(item.enclosure&&item.enclosure.link)||((item.content||'').match(/src="([^"]+)"/) || [])[1];
                const safeTitle=item.title.replace(/'/g,'&apos;');
                const safeLink=item.link.replace(/'/g,'%27');
                return `
                <div class="news-card">
                    ${img?`<img src="${img}" class="h-48 w-full object-cover opacity-80" onerror="this.style.display='none'">`:''}
                    <div class="p-6">
                        <h4 class="text-sm font-bold text-white mb-4 line-clamp-2 leading-tight">${item.title}</h4>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-2">
                                <button class="bg-white/5 p-2.5 rounded-xl text-slate-400 active:scale-90" onclick="saveLinkToPocket('${safeLink}','${safeTitle}')"><i data-lucide="bookmark" size="18"></i></button>
                                <button class="bg-white/5 p-2.5 rounded-xl text-slate-400 active:scale-90" onclick="shareLink('${safeLink}')"><i data-lucide="share-2" size="18"></i></button>
                            </div>
                            <button onclick="sendToROI('${safeTitle}')" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-[9px] font-bold orbitron uppercase active:scale-95">Analyze</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        } catch(e) { list.innerHTML='<p class="text-center py-20 text-red-500 text-xs">Error de red o feed no disponible.</p>'; }
    }
    function renderChips() {
        document.getElementById('discovery-chips').innerHTML = app.rss.map((r,i) =>
            `<button onclick="fetchNews(${i})" class="px-5 py-2 rounded-full text-[10px] whitespace-nowrap transition-all ${app.activeRss===i?'chip-active':'bg-slate-800 text-slate-500'}">${r.name}</button>`
        ).join('');
    }
    function openRssModal() { document.getElementById('modal-rss').classList.remove('hidden'); }
    function addNewRss() {
        const n=document.getElementById('new-rss-name').value.trim(), u=document.getElementById('new-rss-url').value.trim();
        if (!n||!u) return;
        app.rss.push({name:n,url:u,notify:false});
        save(); renderRssNotifyControls(); fetchNews(app.rss.length-1); closeModal('modal-rss');
        ['new-rss-name','new-rss-url'].forEach(id=>document.getElementById(id).value='');
    }
    function delRss(i) { app.rss.splice(i,1); save(); renderRssNotifyControls(); fetchNews(0); }
    function renderRssNotifyControls() {
        const el=document.getElementById('rss-notify-controls'); if(!el) return;
        el.innerHTML = app.rss.map((r,i) => `
            <div class="flex justify-between items-center text-[9px] bg-white/5 p-2 rounded-xl">
                <span class="text-slate-300 truncate flex-1">${r.name}</span>
                <div class="flex items-center gap-2 ml-2">
                    <input type="checkbox" ${r.notify?'checked':''} onchange="toggleRssNotify(${i},this.checked)" class="accent-blue-500">
                    <button onclick="delRss(${i})" class="text-red-500 font-bold text-xs">√ó</button>
                </div>
            </div>`).join('');
    }
    function toggleRssNotify(i,val) { app.rss[i].notify=val; save(); }

    // ==========================================
    // ü§ñ MOTOR NEURAL MULTI-API
    // ==========================================
    async function vicoNeuralLink(promptText) {
        const key=app.config.key.trim();
        if (!key) throw new Error("API Key faltante. A√±√°dela en VICO Core.");
        let url, body, headers={"Content-Type":"application/json"};
        if (key.startsWith('gsk_')) {
            url="https://corsproxy.io/?"+encodeURIComponent("https://api.groq.com/openai/v1/chat/completions");
            headers["Authorization"]=`Bearer ${key}`;
            body={model:"llama-3.3-70b-versatile",messages:[{role:"user",content:promptText}]};
        } else {
            url=`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
            body={contents:[{parts:[{text:promptText}]}]};
        }
        const r=await fetch(url,{method:"POST",headers,body:JSON.stringify(body)});
        const d=await r.json();
        const res=key.startsWith('gsk_')?d.choices[0].message.content:d.candidates[0].content.parts[0].text;
        return res.replace(/[*#`]/g,"");
    }

    // ==========================================
    // üí¨ CHAT
    // ==========================================
    async function sendChat() {
        const inp=document.getElementById('chat-in'), msgs=document.getElementById('chat-msgs');
        if (!inp.value.trim()) return;
        const ut=inp.value.trim();
        msgs.innerHTML+=`<div class="chat-bubble chat-user">${ut}</div>`;
        inp.value=''; msgs.scrollTop=msgs.scrollHeight;
        try {
            const res=await vicoNeuralLink(`Responde de forma profesional y concisa a: "${ut}". Sin asteriscos ni almohadillas.`);
            msgs.innerHTML+=`<div class="chat-bubble chat-bot">${res}</div>`;
        } catch(e) { msgs.innerHTML+=`<div class="text-red-500 text-[9px] p-2">Error: ${e.message}</div>`; }
        msgs.scrollTop=msgs.scrollHeight;
    }

    // ==========================================
    // üìä ROI ENGINE - GR√ÅFICOS PROFESIONALES
    // ==========================================
    function toggleMicrowave() { document.getElementById('vico-microwave').classList.toggle('hidden'); }

    // Prompt mejorado que extrae datos reales estructurados
    async function runROIAnalysis() {
        const q=document.getElementById('ai-query').value.trim();
        if (!q) return alert("Define el objetivo de an√°lisis.");
        const btn=document.getElementById('btn-ai');
        const micro=document.getElementById('vico-microwave');
        btn.disabled=true; micro.classList.remove('hidden');
        document.getElementById('microwave-content').innerHTML='';

        let progress=0;
        const thoughts=["Indexando mercados globales 2026...","Calculando m√°rgenes y EBITDA...","Comparando competidores sector...","Extrayendo m√©tricas clave...","Generando proyecciones 12 meses...","Estructurando informe ejecutivo...","Renderizando gr√°ficos profesionales..."];
        const interval=setInterval(()=>{
            progress++;
            document.getElementById('pomo-knob').style.setProperty('--progress',(progress*3.6)+'deg');
            document.getElementById('micro-percent').innerText=progress+'%';
            if (progress%15===0) { const mc=document.getElementById('microwave-content'); mc.innerHTML=(thoughts[Math.floor(progress/15)-1]||'')+"\n"+mc.innerHTML; }
            if (progress>=100) clearInterval(interval);
        }, 70);

        try {
            const megaPrompt = `Eres un analista financiero senior de Goldman Sachs especializado en mercados globales. Fecha actual: ${new Date().toLocaleDateString('es-ES', {day:'2-digit', month:'long', year:'numeric'})}.

ANALIZA EN PROFUNDIDAD: "${q}"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PARTE 1 ‚Äî INFORME EJECUTIVO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Redacta 4-5 p√°rrafos ejecutivos con:
- Contexto macroecon√≥mico actual y situaci√≥n del sector en 2025-2026
- M√©tricas financieras REALES y ACTUALES: precios reales de cotizaci√≥n, market cap en d√≥lares/euros, P/E ratio, margen EBITDA %, crecimiento YoY %, cuota de mercado %
- An√°lisis competitivo con nombres reales de empresas/activos del sector analizado
- Riesgos geopol√≠ticos, regulatorios y de mercado con cifras concretas
- Recomendaci√≥n de inversi√≥n fundamentada con precio objetivo y horizonte temporal
Escribe sin asteriscos, sin almohadillas, sin Markdown. Solo texto plano profesional.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PARTE 2 ‚Äî DATOS JSON PARA GR√ÅFICOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CR√çTICO: Adapta TODOS los nombres, valores y cifras al tema REAL analizado. No uses placeholders gen√©ricos.
Usa nombres reales de empresas/activos, precios reales de mercado, porcentajes reales del sector.

CHART_DATA_START
{
  "entities": ["NombreReal_Empresa_A", "NombreReal_Empresa_B", "NombreReal_Empresa_C"],
  "months": ["Ene 25","Feb 25","Mar 25","Abr 25","May 25","Jun 25","Jul 25","Ago 25","Sep 25","Oct 25","Nov 25","Dic 25"],
  "price_series": {
    "A": [PRECIO_REAL_ENE, PRECIO_REAL_FEB, PRECIO_REAL_MAR, PRECIO_REAL_ABR, PRECIO_REAL_MAY, PRECIO_REAL_JUN, PRECIO_REAL_JUL, PRECIO_REAL_AGO, PRECIO_REAL_SEP, PRECIO_REAL_OCT, PRECIO_REAL_NOV, PRECIO_REAL_DIC],
    "B": [12 VALORES REALES],
    "C": [12 VALORES REALES]
  },
  "market_share": {"NombreEmpresaA": PORCENTAJE_REAL, "NombreEmpresaB": PORCENTAJE_REAL, "NombreEmpresaC": PORCENTAJE_REAL, "Resto mercado": PORCENTAJE_REAL},
  "attributes": {
    "labels": ["Innovaci√≥n I+D","Rentabilidad","Crecimiento Rev.","Solidez Balance","Posici√≥n Mercado"],
    "A": [VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100],
    "B": [VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100],
    "C": [VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100, VALOR_0_100]
  },
  "performance": {
    "labels": ["ROI Anual %","Margen Neto %","EBITDA %","Crecim. YoY %","Cuota Mdo. %"],
    "A": [VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL],
    "B": [VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL],
    "C": [VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL, VALOR_REAL]
  },
  "risk_months": ["Q1 2025","Q2 2025","Q3 2025","Q4 2025"],
  "risk_series": {
    "A": [RIESGO_Q1, RIESGO_Q2, RIESGO_Q3, RIESGO_Q4],
    "B": [RIESGO_Q1, RIESGO_Q2, RIESGO_Q3, RIESGO_Q4],
    "C": [RIESGO_Q1, RIESGO_Q2, RIESGO_Q3, RIESGO_Q4]
  },
  "impact": {"NombreEmpresaA": VALOR_0_100, "NombreEmpresaB": VALOR_0_100, "NombreEmpresaC": VALOR_0_100},
  "kpis": [
    {"label":"L√≠der del sector","value":"NombreReal","trend":"Market cap: $XXB","color":"cyan"},
    {"label":"ROI Promedio sector","value":"XX.X%","trend":"vs +X.X% a√±o anterior","color":"green"},
    {"label":"Crecimiento YoY","value":"+XX.X%","trend":"Proyecci√≥n 2026: +XX%","color":"blue"},
    {"label":"Riesgo Sectorial","value":"Alto/Medio/Bajo","trend":"Volatilidad: XX%","color":"yellow"}
  ],
  "table": {
    "headers": ["Empresa/Activo","Precio actual","Var. 12m","Market Cap","ROI","Margen EBITDA","Se√±al"],
    "rows": [
      ["NombreReal_A","$XXX.XX","+XX.X%","$X.XT","XX%","XX%","COMPRAR"],
      ["NombreReal_B","$XXX.XX","+XX.X%","$X.XT","XX%","XX%","MANTENER"],
      ["NombreReal_C","$XXX.XX","+XX.X%","$X.XT","XX%","XX%","OBSERVAR"]
    ]
  }
}
CHART_DATA_END

RECUERDA: Sustituye TODOS los placeholders con datos REALES y ESPEC√çFICOS del tema analizado.`;

            const aiResponse=await vicoNeuralLink(megaPrompt);

            // Extraer las dos partes
            const chartMatch=aiResponse.match(/CHART_DATA_START\s*([\s\S]*?)\s*CHART_DATA_END/);
            let chartData=null;
            let cleanText=aiResponse;

            if (chartMatch) {
                try {
                    chartData=JSON.parse(chartMatch[1]);
                    cleanText=aiResponse.replace(/CHART_DATA_START[\s\S]*CHART_DATA_END/,'').replace('=== PARTE 1: INFORME EJECUTIVO ===','').replace('=== PARTE 2: DATOS PARA GR√ÅFICOS ===','').trim();
                } catch(parseErr) { console.warn('JSON parse error, usando datos de fallback',parseErr); }
            }

            // Fallback si la IA no gener√≥ el JSON correctamente
            if (!chartData) {
                chartData = buildFallbackData(q);
            }

            clearInterval(interval);
            playSound('800'); setTimeout(()=>playSound('1500'),150);

            document.getElementById('report-date').innerText=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'long',year:'numeric'});
            document.getElementById('footer-date').innerText=new Date().toLocaleString('es-ES');
            document.getElementById('ai-results').classList.remove('hidden');
            document.getElementById('ai-report').innerText=cleanText;

            renderKPIs(chartData.kpis);
            renderAllChartsPro(chartData);
            renderDataTable(chartData.table);

            document.getElementById('ai-results').scrollIntoView({behavior:'smooth'});

        } catch(e) { alert("VICO: "+e.message); clearInterval(interval); }
        finally { btn.disabled=false; micro.classList.add('hidden'); }
    }

    // Datos de fallback si la IA no formatea el JSON
    function buildFallbackData(query) {
        const now=new Date(); const months=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const seed=query.length;
        const base=[100+seed%20, 80+seed%15, 55+seed%10];
        const series=(b,v)=>months.map((_,i)=>Math.round(b+v*i+(Math.sin(i)*5)));
        return {
            entities:['Activo A','Activo B','Activo C'], months,
            price_series:{ A:series(base[0],2.5), B:series(base[1],2.2), C:series(base[2],1.8) },
            market_share:{ A:38, B:27, C:20, Otros:15 },
            attributes:{ labels:['Innovaci√≥n','Rentabilidad','Crecimiento','Liquidez','Posici√≥n'], A:[82,75,88,68,85], B:[70,82,65,88,72], C:[62,58,70,78,65] },
            performance:{ labels:['ROI%','Margen%','EBITDA%','Crecim.%','Cuota%'], A:[22,18,35,28,38], B:[18,22,28,15,27], C:[12,14,20,20,20] },
            risk_months:['Ene','Abr','Jul','Oct'], risk_series:{ A:[12,18,15,22], B:[8,14,10,16], C:[20,25,18,28] },
            impact:{ A:85, B:72, C:60 },
            kpis:[{label:'L√≠der Mercado',value:'Activo A',trend:'+12%',color:'cyan'},{label:'ROI Promedio',value:'17.3%',trend:'+3.8%',color:'green'},{label:'Crecim. YoY',value:'21.5%',trend:'+6.2%',color:'blue'},{label:'Riesgo',value:'Moderado',trend:'‚ö†Ô∏è',color:'yellow'}],
            table:{ headers:['Activo','Valor','Var%','ROI','Margen','Se√±al'], rows:[['Activo A','$182','+12.3%','22%','18%','COMPRAR'],['Activo B','$145','+8.1%','18%','22%','MANTENER'],['Activo C','$68','+15.2%','12%','14%','OBSERVAR']] }
        };
    }

    // KPIs tarjetas destacadas
    function renderKPIs(kpis) {
        if (!kpis||!kpis.length) return;
        const colorMap={cyan:'text-cyan-400 border-cyan-500/30',green:'text-green-400 border-green-500/30',blue:'text-blue-400 border-blue-500/30',yellow:'text-yellow-400 border-yellow-500/30'};
        document.getElementById('kpi-cards').innerHTML=kpis.map(k=>`
            <div class="glass-panel p-4 rounded-2xl border ${colorMap[k.color]||'border-white/10'} text-center">
                <div class="text-[8px] text-slate-500 uppercase font-bold mb-1">${k.label}</div>
                <div class="text-lg font-bold orbitron ${colorMap[k.color]?.split(' ')[0]||'text-white'}">${k.value}</div>
                <div class="text-[9px] text-slate-400 mt-1">${k.trend}</div>
            </div>`).join('');
    }

    // Tabla de datos profesional
    function renderDataTable(table) {
        if (!table) return;
        const trendColor=v=>v.includes('+')?' style="color:#10b981"':v.includes('COMPRAR')?' style="color:#10b981;font-weight:bold"':v.includes('MANTENER')?' style="color:#fbbf24;font-weight:bold"':v.includes('OBSERVAR')?' style="color:#f87171;font-weight:bold"':'';
        document.getElementById('table-head').innerHTML=table.headers.map(h=>`<th class="text-left py-2 px-3 text-[8px] text-slate-500 uppercase font-bold">${h}</th>`).join('');
        document.getElementById('table-body').innerHTML=table.rows.map((row,ri)=>
            `<tr class="${ri%2===0?'bg-white/[0.02]':''}">
                ${row.map(cell=>`<td class="py-2 px-3 text-[9px] text-slate-300 font-mono"${trendColor(cell)}>${cell}</td>`).join('')}
            </tr>`
        ).join('');
    }

    // Gr√°ficos profesionales con datos reales de la IA
    function renderAllChartsPro(d) {
        const C={'A':'#00fff7','B':'#3b82f6','C':'#d946ef'};
        const BG={'A':'rgba(0,255,247,0.15)','B':'rgba(59,130,246,0.15)','C':'rgba(217,70,239,0.15)'};
        const gridOpts={color:'rgba(255,255,255,0.04)'};
        const tickOpts={color:'#475569',font:{size:7,family:'monospace'}};
        const baseOpts={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:'bottom',labels:{color:'#94a3b8',font:{size:7},boxWidth:8}},tooltip:{backgroundColor:'#0b0f1a',titleFont:{family:'Orbitron',size:9},bodyFont:{size:8},borderColor:'rgba(255,255,255,0.1)',borderWidth:1}}};

        // Helpers para limpiar charts anteriores
        const mk=(id,type,data,opts)=>{
            const ctx=document.getElementById(id); if(!ctx) return;
            const ex=Chart.getChart(id); if(ex) ex.destroy();
            new Chart(ctx.getContext('2d'),{type,data,options:opts});
        };

        // Describir los gr√°ficos con info contextual
        const setDesc=(id,txt)=>{const e=document.getElementById(id);if(e)e.innerText=txt;};
        const avg=arr=>arr.length?(arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(1):0;
        const ents=d.entities||['A','B','C'];

        setTimeout(()=>{
            // CHART 1 ‚Äî L√çNEA TEMPORAL (precio 12 meses) con meses reales
            const maxA=Math.max(...(d.price_series.A||[])), minA=Math.min(...(d.price_series.A||[]));
            setDesc('chart-stock-label',`M√°x: ${maxA} ¬∑ M√≠n: ${minA} ¬∑ Var: +${(((maxA-minA)/minA)*100).toFixed(1)}%`);
            setDesc('chart-stock-desc',`Proyecci√≥n de cotizaci√≥n mensual para ${ents.join(', ')} (12 meses)`);
            mk('chartStock','line',{
                labels:d.months||[],
                datasets:['A','B','C'].filter(k=>d.price_series[k]).map(k=>({
                    label:ents[['A','B','C'].indexOf(k)]||k, data:d.price_series[k],
                    borderColor:C[k], backgroundColor:BG[k], fill:true, tension:0.4, borderWidth:2,
                    pointBackgroundColor:C[k], pointRadius:3, pointHoverRadius:5
                }))
            },{...baseOpts,scales:{y:{grid:gridOpts,ticks:tickOpts,title:{display:true,text:'Precio/Valor',color:'#475569',font:{size:7}}},x:{grid:{display:false},ticks:tickOpts}}});

            // CHART 2 ‚Äî RADAR atributos con datos reales
            const attrLabels=d.attributes?.labels||['Innov.','Rentab.','Crecim.','Liquid.','Posici√≥n'];
            setDesc('chart-radar-desc',`Perfil multidimensional: ${ents.join(' vs ')}`);
            mk('chartRadarPro','radar',{
                labels:attrLabels,
                datasets:['A','B','C'].filter(k=>d.attributes?.[k]).map(k=>({
                    label:ents[['A','B','C'].indexOf(k)]||k, data:d.attributes[k],
                    borderColor:C[k], backgroundColor:BG[k], borderWidth:1.5, pointRadius:2
                }))
            },{...baseOpts,scales:{r:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#475569',font:{size:6},backdropColor:'transparent'},pointLabels:{color:'#94a3b8',font:{size:7}}}}});

            // CHART 3 ‚Äî DONUT cuota de mercado
            const pieLabels=Object.keys(d.market_share||{A:38,B:27,C:20,Otros:15});
            const pieValues=Object.values(d.market_share||{A:38,B:27,C:20,Otros:15});
            setDesc('chart-pie-desc',`Distribuci√≥n del mercado ‚Äî L√≠der: ${pieLabels[0]} (${pieValues[0]}%)`);
            mk('chartPiePro','doughnut',{
                labels:pieLabels,
                datasets:[{data:pieValues,backgroundColor:['#00fff7','#3b82f6','#d946ef','#1e293b'],borderColor:'#0b0f1a',borderWidth:3,hoverOffset:8}]
            },{...baseOpts,cutout:'65%',plugins:{...baseOpts.plugins,legend:{...baseOpts.plugins.legend,position:'right'}}});

            // CHART 4 ‚Äî BARRAS comparativa rendimiento con PORCENTAJES
            const perfLabels=d.performance?.labels||['ROI%','Margen%','EBITDA%','Crecim.%','Cuota%'];
            const avgA=avg(d.performance?.A||[]);
            setDesc('chart-bar-desc',`Indicadores operativos clave ‚Äî Promedio ${ents[0]}: ${avgA}%`);
            setDesc('chart-bar-avg',`Avg: ${avgA}%`);
            mk('chartBarPro','bar',{
                labels:perfLabels,
                datasets:['A','B','C'].filter(k=>d.performance?.[k]).map(k=>({
                    label:ents[['A','B','C'].indexOf(k)]||k, data:d.performance[k],
                    backgroundColor:BG[k], borderColor:C[k], borderWidth:1.5, borderRadius:6
                }))
            },{...baseOpts,scales:{y:{grid:gridOpts,ticks:{...tickOpts,callback:v=>v+'%'}},x:{grid:{display:false},ticks:tickOpts}}});

            // CHART 5 ‚Äî √ÅREA varianza de riesgo trimestral
            setDesc('chart-area-desc',`Exposici√≥n al riesgo por trimestre ‚Äî Mayor en ${ents[2]||'C'}`);
            mk('chartAreaPro','line',{
                labels:d.risk_months||['Q1','Q2','Q3','Q4'],
                datasets:['A','B','C'].filter(k=>d.risk_series?.[k]).map(k=>({
                    label:ents[['A','B','C'].indexOf(k)]||k, data:d.risk_series[k],
                    borderColor:C[k], backgroundColor:BG[k], fill:true, tension:0.4, borderWidth:1.5, pointRadius:3
                }))
            },{...baseOpts,scales:{y:{grid:gridOpts,ticks:{...tickOpts,callback:v=>v+'%'}},x:{grid:{display:false},ticks:tickOpts}}});

            // CHART 6 ‚Äî BARRAS HORIZONTALES impacto global
            const impactLabels=Object.keys(d.impact||{A:85,B:72,C:60}).map((k,i)=>ents[i]||k);
            const impactValues=Object.values(d.impact||{A:85,B:72,C:60});
            setDesc('chart-comp-desc',`√çndice de impacto global (0-100) ‚Äî Benchmarking sectorial`);
            mk('chartComparison','bar',{
                labels:impactLabels,
                datasets:[{label:'Impacto Global',data:impactValues,backgroundColor:['rgba(0,255,247,0.3)','rgba(59,130,246,0.3)','rgba(217,70,239,0.3)'],borderColor:['#00fff7','#3b82f6','#d946ef'],borderWidth:2,borderRadius:8}]
            },{...baseOpts,indexAxis:'y',scales:{x:{grid:gridOpts,ticks:{...tickOpts,callback:v=>v+'%'},max:100},y:{grid:{display:false},ticks:tickOpts}}});

        },200);
    }

    // ==========================================
    // üì§ COMPARTIR INFORME (nativo Android)
    // ==========================================
    async function shareReport() {
        const reportText = document.getElementById('ai-report').innerText;
        const reportDate = document.getElementById('report-date').innerText;
        const shareData = {
            title: `Informe VICO ROI - ${reportDate}`,
            text: `üìä INFORME EJECUTIVO VICO POCKET OS\n${reportDate}\n\n${reportText.substring(0,1500)}...\n\nGenerado por VICO POCKET OS v13`
        };
        if (navigator.share) {
            try {
                await navigator.share(shareData);
            } catch(e) {
                if (e.name !== 'AbortError') window.print();
            }
        } else {
            window.print();
        }
    }

    function analyzeFile(input) {
        const file=input.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=e=>{ document.getElementById('ai-query').value=`Analiza este documento: ${file.name}\n\n${e.target.result.substring(0,2000)}`; };
        reader.readAsText(file);
    }
    function sendToROI(t) { document.getElementById('ai-query').value=`An√°lisis estrat√©gico y ROI: ${t}`; switchTab('view-analysis'); }

    // ==========================================
    // ‚è±Ô∏è POMODORO
    // ==========================================
    function openPomo()  { document.getElementById('modal-pomo').classList.remove('hidden'); }
    function minimizePomo() { document.getElementById('modal-pomo').classList.add('hidden'); if(app.pomo.active) document.getElementById('top-taskbar').classList.remove('hidden'); }
    function toggleFocus() {
        const ctrl=document.getElementById('pomo-ctrl'), tb=document.getElementById('top-taskbar');
        if (app.pomo.active) {
            clearInterval(app.pomo.timer); app.pomo.active=false; tb.classList.add('hidden');
            ctrl.innerHTML='<i data-lucide="play" fill="white"></i>';
        } else {
            app.pomo.active=true; tb.classList.remove('hidden'); ctrl.innerHTML='<i data-lucide="pause" fill="white"></i>';
            app.pomo.timer=setInterval(()=>{ app.pomo.time--; updatePomoUI(); if(app.pomo.time<=0){resetFocus();alert("¬°Focus completado! Descansa.");} },1000);
        }
        lucide.createIcons();
    }
    function resetFocus() {
        clearInterval(app.pomo.timer); app.pomo.time=1500; app.pomo.active=false;
        document.getElementById('top-taskbar').classList.add('hidden'); updatePomoUI();
        document.getElementById('pomo-ctrl').innerHTML='<i data-lucide="play" fill="white"></i>'; lucide.createIcons();
    }
    function updatePomoUI() {
        const m=Math.floor(app.pomo.time/60),s=app.pomo.time%60;
        const str=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        document.getElementById('pomo-clock').innerText=str; document.getElementById('mini-timer').innerText=str;
    }

    // ==========================================
    // üéõÔ∏è BOTONES & EXPORTACI√ìN
    // ==========================================
    function createCustomBtn() {
        const l=document.getElementById('btn-name').value.trim(), u=document.getElementById('btn-url').value.trim();
        if (!l||!u) return;
        app.btns.push({id:Date.now().toString(),label:l,url:u}); save(); renderCustomBtns();
        ['btn-name','btn-url'].forEach(id=>document.getElementById(id).value='');
    }
    function renderCustomBtns() {
        document.getElementById('custom-buttons-dashboard').innerHTML=app.btns.map(b=>
            `<button onclick="window.open('${b.url}','_blank')" class="bg-blue-600/20 border border-blue-500/30 px-5 py-2 rounded-2xl text-[10px] font-bold text-blue-400 m-1 active:scale-95 transition-all">${b.label}</button>`
        ).join('');
    }
    function exportOSData() {
        const blob=new Blob([JSON.stringify(app)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`vico_backup_${Date.now()}.json`; a.click();
    }
    function importOSData(input) {
        const reader=new FileReader();
        reader.onload=e=>{ try{app=JSON.parse(e.target.result);save();location.reload();}catch(err){alert("Error al importar JSON.");} };
        reader.readAsText(input.files[0]);
    }
    function forceSystemUpdate() {
        playSound('siren');
        if ('serviceWorker' in navigator) {
            caches.keys().then(n=>{for(let x of n)caches.delete(x);});
            navigator.serviceWorker.getRegistrations().then(r=>{for(let x of r)x.unregister();});
        }
        setTimeout(()=>location.reload(true),500);
    }

    // ==========================================
    // üîÑ NAVEGACI√ìN
    // ==========================================
    function switchTab(id,el) {
        playSound(600);
        document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        if (el) { el.classList.add('active'); }
        else {
            // Activar nav item correspondiente si se llama sin elemento
            const map={'view-dashboard':0,'view-notes':1,'view-links':2,'view-analysis':3,'view-discovery':4,'view-calendar':5,'view-profile':6};
            const idx=map[id]; if(idx!==undefined) document.querySelectorAll('.nav-item')[idx]?.classList.add('active');
        }
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function openLinkModal()  { document.getElementById('modal-link').classList.remove('hidden'); }
    function openEventModal() { document.getElementById('modal-event').classList.remove('hidden'); }
    function toggleChat()     { document.getElementById('chat-win').classList.toggle('hidden'); playSound(500); }

    function renderDashboard() {
        document.getElementById('stat-notes').innerText=app.notes.length;
        document.getElementById('stat-links').innerText=app.links.length;
        document.getElementById('stat-tasks').innerText=app.kanban.length;
        document.getElementById('dash-events-label').innerText=`Agenda (${app.events.length})`;
    }

    function renderAll() {
        renderNotes(); renderDashboard(); renderKanban(); renderLinks();
        renderEvents(); renderCustomBtns(); renderChips(); fetchNews(0);
        renderRssNotifyControls(); renderNotifHistory();
    }

    // ==========================================
    // üîó SHARE TARGET
    // ==========================================
    function checkShareTarget() {
        const params=new URLSearchParams(window.location.search);
        const sharedUrl=params.get('url')||params.get('text'), sharedTitle=params.get('title');
        if (sharedUrl) {
            const cleanUrl=sharedUrl.match(/https?:\/\/[^\s]+/)?.[0]||sharedUrl;
            document.getElementById('lk-url').value=cleanUrl;
            document.getElementById('lk-title').value=sharedTitle||'';
            document.getElementById('modal-link').classList.remove('hidden');
            switchTab('view-links'); playSound('pulsar');
            window.history.replaceState({},'',window.location.pathname);
        }
    }

    // ==========================================
    // üì≤ PWA INSTALL
    // ==========================================
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt',e=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('install-banner').classList.remove('hidden'); });
    async function triggerPwaInstall() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const {outcome}=await deferredPrompt.userChoice;
        if (outcome==='accepted') document.getElementById('install-banner').classList.add('hidden');
        deferredPrompt=null;
    }

    // ==========================================
    // üöÄ ARRANQUE
    // ==========================================
    window.addEventListener('load', async () => {
        lucide.createIcons();
        applySystemConfig();
        renderAll();
        checkShareTarget();
        setInterval(checkAgenda, 20000);

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            try {
                const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
                console.log('VICO SW registrado:', reg.scope);

                // Escuchar mensajes del SW (ej: click en notificaci√≥n ‚Üí abrir agenda)
                navigator.serviceWorker.addEventListener('message', e => {
                    if (e.data && e.data.action === 'open-agenda') {
                        switchTab('view-calendar');
                    }
                });
            } catch(e) {
                console.warn('SW registro fallido:', e);
            }
        }

        // Restaurar estado de permisos de notificaci√≥n
        if ('Notification' in window && Notification.permission === 'granted' && app.config.notifications) {
            const bar = document.getElementById('notif-status-bar');
            const btn = document.getElementById('btn-notif-perm');
            if (bar) bar.classList.remove('hidden');
            if (btn) btn.innerText = '‚úÖ Activas';
        }
    });
    </script>

    <!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë  VICO POCKET OS v14 ¬∑ sw.js REQUERIDO (pantalla de bloqueo) ‚ïë
    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
    ‚ïë  Para que las notificaciones funcionen en la pantalla de     ‚ïë
    ‚ïë  bloqueo de Android, tu sw.js DEBE incluir este handler:     ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë  self.addEventListener('notificationclick', e => {           ‚ïë
    ‚ïë    e.notification.close();                                   ‚ïë
    ‚ïë    const url = e.notification.data?.url || '/';              ‚ïë
    ‚ïë    if (e.action === 'open' || !e.action) {                   ‚ïë
    ‚ïë      e.waitUntil(                                            ‚ïë
    ‚ïë        clients.matchAll({type:'window'}).then(cs => {        ‚ïë
    ‚ïë          if (cs.length) { cs[0].focus(); return; }           ‚ïë
    ‚ïë          return clients.openWindow(url);                     ‚ïë
    ‚ïë        })                                                    ‚ïë
    ‚ïë      );                                                      ‚ïë
    ‚ïë    }                                                         ‚ïë
    ‚ïë  });                                                         ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    -->
</body>
</html>
