<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>VICO POCKET AI</title>
    <meta name="theme-color" content="#0b0f1a">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #0b0f1a; --primary: #3b82f6; --glass: rgba(255, 255, 255, 0.05); }
        
        /* Temas Dinámicos del Pack DUVI */
        body.theme-Cyber { --bg: #050b1a; --primary: #00fff7; --accent: #3b82f6; }
        body.theme-Gold { --bg: #1a1605; --primary: #fbbf24; --accent: #d97706; }
        body.theme-Nature { --bg: #051a0b; --primary: #10b981; --accent: #059669; }
        body.theme-Nebula { --bg: #13051a; --primary: #d946ef; --accent: #a21caf; }
        body.theme-Minimal { --bg: #000000; --primary: #ffffff; --accent: #666666; }

        body { background-color: var(--bg); color: #e2e8f0; font-family: 'Inter', sans-serif; transition: 0.3s; margin: 0; }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .glass-panel { background: rgba(11, 15, 26, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none !important; }
        
        /* Navegación Inferior */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 75px;
            background: rgba(11, 15, 26, 0.95); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #64748b; font-size: 8px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, textarea, select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 10px; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body class="theme-Cyber">

    <main id="app-content" class="h-screen w-full overflow-y-auto pb-24">
        <section id="view-dashboard" class="p-4 space-y-6 fade-in">
            <div class="p-6 rounded-2xl border border-blue-500/30 bg-gradient-to-br from-blue-900/20 to-transparent flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold orbitron text-white">VICO POCKET</h1>
                    <p id="daily-phrase" class="text-slate-400 italic text-xs mt-1">"El conocimiento es poder."</p>
                </div>
                <div id="pomo-mini" class="hidden bg-red-600/20 px-3 py-1 rounded-full border border-red-500 text-red-500 font-mono text-xs animate-pulse">00:00</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center cursor-pointer" onclick="switchTab('view-notes')">
                    <i data-lucide="file-text" class="text-blue-400 mb-2"></i>
                    <span class="text-[10px] font-bold">NOTAS</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center cursor-pointer" onclick="switchTab('view-links')">
                    <i data-lucide="bookmark" class="text-green-400 mb-2"></i>
                    <span class="text-[10px] font-bold">LINKS</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center cursor-pointer" onclick="switchTab('view-analysis')">
                    <i data-lucide="activity" class="text-purple-400 mb-2"></i>
                    <span class="text-[10px] font-bold">IA ROI</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center cursor-pointer" onclick="openPomodoro()">
                    <i data-lucide="zap" class="text-yellow-400 mb-2"></i>
                    <span class="text-[10px] font-bold">FOCUS</span>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-xl">
                <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-3">Estadísticas Locales</h3>
                <div class="flex justify-around text-center">
                    <div><div id="dash-notes-count" class="text-xl font-bold text-white">0</div><div class="text-[8px] text-slate-500">NOTAS</div></div>
                    <div><div id="dash-links-count" class="text-xl font-bold text-white">0</div><div class="text-[8px] text-slate-500">LINKS</div></div>
                    <div><div id="dash-events-count" class="text-xl font-bold text-white">0</div><div class="text-[8px] text-slate-500">CITAS</div></div>
                </div>
            </div>
        </section>

        <section id="view-notes" class="hidden p-4 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold orbitron">Notas Pocket</h2>
                <button onclick="showNoteModal()" class="bg-blue-600 p-2 rounded-full"><i data-lucide="plus"></i></button>
            </div>
            <div id="notes-container" class="space-y-3"></div>
        </section>

        <section id="view-links" class="hidden p-4 fade-in">
            <h2 class="text-xl font-bold orbitron mb-4">Links Guardados</h2>
            <div class="glass-panel p-4 rounded-xl mb-4 space-y-2">
                <input type="text" id="link-input" placeholder="Pegar URL (https://...)" class="w-full text-sm">
                <button onclick="saveLink()" class="w-full bg-green-600 py-2 rounded-lg font-bold text-sm">Guardar Enlace</button>
            </div>
            <div id="links-container" class="space-y-2"></div>
        </section>

        <section id="view-analysis" class="hidden p-4 fade-in">
            <h2 class="text-xl font-bold orbitron mb-4 text-purple-400">Motor Neural ROI</h2>
            <div class="glass-panel p-4 rounded-xl mb-4 space-y-3">
                <textarea id="analysis-query" placeholder="Ej: Comparativa Apple vs Samsung 2026..." class="w-full text-sm h-24 resize-none"></textarea>
                <button id="btn-run-analysis" onclick="runNeuralAnalysis()" class="w-full bg-purple-600 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                    <i data-lucide="brain"></i> Generar Informe Real
                </button>
            </div>
            <div id="analysis-report" class="space-y-4"></div>
        </section>

        <section id="view-discovery" class="hidden p-4 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold orbitron">Descubre</h2>
                <button onclick="loadNews()" class="text-blue-400"><i data-lucide="refresh-cw"></i></button>
            </div>
            <div id="news-container" class="space-y-4"></div>
        </section>

        <section id="view-calendar" class="hidden p-4 fade-in">
            <h2 class="text-xl font-bold orbitron mb-4">Agenda</h2>
            <div class="glass-panel p-4 rounded-xl mb-4 space-y-2">
                <input type="datetime-local" id="event-date" class="w-full text-sm">
                <input type="text" id="event-desc" placeholder="Asunto de la cita..." class="w-full text-sm">
                <button onclick="saveEvent()" class="w-full bg-blue-600 py-2 rounded-lg font-bold">Agendar</button>
            </div>
            <div id="events-container" class="space-y-2"></div>
        </section>

        <section id="view-profile" class="hidden p-4 fade-in">
            <h2 class="text-xl font-bold orbitron mb-6 text-slate-400">VICO Core</h2>
            
            <div class="glass-panel p-4 rounded-xl mb-6">
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-3">Configuración IA</h3>
                <input type="password" id="api-key-input" placeholder="Pega tu API Key..." class="w-full text-xs font-mono mb-3" oninput="detectKey(this.value)">
                <div id="key-status" class="text-[9px] text-slate-500 mb-3">Introduce clave para detectar motor.</div>
                <button onclick="saveApiConfig()" class="w-full bg-green-600 py-2 rounded-lg text-xs font-bold">Guardar Configuración</button>
            </div>

            <div class="glass-panel p-4 rounded-xl mb-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Personalización</h3>
                <select id="theme-select" onchange="updateTheme(this.value)" class="w-full text-xs">
                    <option value="Cyber">Cyber Blue</option>
                    <option value="Gold">Luxury Gold</option>
                    <option value="Nature">Nature Green</option>
                    <option value="Nebula">Cosmic Nebula</option>
                    <option value="Minimal">Dark Minimal</option>
                </select>
            </div>

            <div id="legal-box" class="glass-panel p-4 rounded-xl text-[10px] text-slate-500 text-justify mb-6 leading-relaxed">
                <h4 class="font-bold text-slate-400 mb-1">Aviso Legal y Privacidad</h4>
                <p>VICO POCKET AI es una herramienta de gestión local. Tus datos (notas, claves, historial) se guardan exclusivamente en tu navegador. No almacenamos información en servidores externos. El uso de la IA y el acceso a links externos es responsabilidad del usuario final.</p>
            </div>

            <div class="text-center space-y-4">
                <a href="https://www.paypal.com/paypalme/texiduvi" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 px-6 py-2 rounded-full font-bold text-xs">
                    <i data-lucide="coffee" size="14"></i> Invítame un Café
                </a>
                <div class="text-[9px] text-slate-500">
                    &copy; 2026 VICO POCKET AI. <br>
                    Desarrollado por <a href="https://www.linkedin.com/in/jaime-andrés-dueñas-vicuña" class="text-blue-400 font-bold">Jaime Andrés Dueñas Vicuña</a>
                </div>
            </div>
        </section>
    </main>

    <nav class="nav-bar">
        <div class="nav-item active" onclick="switchTab('view-dashboard', this)"><i data-lucide="home"></i><span>HOME</span></div>
        <div class="nav-item" onclick="switchTab('view-notes', this)"><i data-lucide="file-text"></i><span>NOTAS</span></div>
        <div class="nav-item" onclick="switchTab('view-links', this)"><i data-lucide="bookmark"></i><span>LINKS</span></div>
        <div class="nav-item" onclick="switchTab('view-analysis', this)"><i data-lucide="pie-chart"></i><span>IA ROI</span></div>
        <div class="nav-item" onclick="switchTab('view-discovery', this)"><i data-lucide="compass"></i><span>DESCUBRE</span></div>
        <div class="nav-item" onclick="switchTab('view-calendar', this)"><i data-lucide="calendar"></i><span>AGENDA</span></div>
        <div class="nav-item" onclick="switchTab('view-profile', this)"><i data-lucide="settings"></i><span>PERFIL</span></div>
    </nav>

    <div id="note-modal" class="fixed inset-0 z-[200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 space-y-4 border-blue-500/50">
            <h3 class="font-bold orbitron text-blue-400">Nueva Nota</h3>
            <input type="text" id="note-title" placeholder="Título..." class="w-full text-sm">
            <textarea id="note-text" placeholder="Escribe aquí..." class="w-full text-sm h-32"></textarea>
            <div class="flex gap-2">
                <button onclick="saveNote()" class="flex-1 bg-blue-600 py-2 rounded-lg font-bold">Guardar</button>
                <button onclick="hideNoteModal()" class="flex-1 bg-slate-800 py-2 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="pomo-modal" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 hidden">
        <div class="text-center space-y-8">
            <div id="pomo-timer" class="text-8xl font-mono font-bold text-white orbitron">25:00</div>
            <div class="flex justify-center gap-6">
                <button id="pomo-ctrl" onclick="togglePomo()" class="bg-blue-600 p-6 rounded-full shadow-2xl"><i data-lucide="play" class="text-white"></i></button>
                <button onclick="resetPomo()" class="bg-slate-800 p-6 rounded-full"><i data-lucide="rotate-ccw"></i></button>
            </div>
            <button onclick="closePomodoro()" class="text-slate-500 underline text-xs">Cerrar Focus</button>
        </div>
    </div>

    <div id="vico-chat-ui" class="fixed bottom-24 right-4 z-[150]">
        <button onclick="toggleChat()" class="bg-blue-600 p-4 rounded-full shadow-2xl"><i data-lucide="bot" class="text-white"></i></button>
        <div id="chat-box" class="glass-panel fixed bottom-40 right-4 w-80 h-96 rounded-2xl flex flex-col hidden border-blue-500/30">
            <div class="bg-blue-600 p-3 flex justify-between items-center rounded-t-2xl">
                <span class="text-xs font-bold text-white uppercase tracking-widest">VICO AI Chat</span>
                <button onclick="toggleChat()"><i data-lucide="x" size="14"></i></button>
            </div>
            <div id="chat-msgs" class="flex-1 overflow-y-auto p-3 space-y-2 text-xs"></div>
            <div class="p-2 border-t border-slate-700 flex gap-1">
                <input type="text" id="chat-input" placeholder="Pregunta algo..." class="flex-1 text-[10px] p-2 bg-slate-900 border-none rounded">
                <button onclick="sendChatMessage()" class="bg-blue-600 p-2 rounded"><i data-lucide="send" size="14"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO INICIAL ---
        let state = {
            notes: JSON.parse(localStorage.getItem('vp_notes')) || [],
            links: JSON.parse(localStorage.getItem('vp_links')) || [],
            events: JSON.parse(localStorage.getItem('vp_events')) || [],
            config: JSON.parse(localStorage.getItem('vp_config')) || { key: '', provider: 'gemini', theme: 'Cyber' },
            pomo: { time: 1500, active: false, interval: null }
        };

        const VICO_PROMPT = "Eres VICO, un asistente inteligente experto en ROI, análisis de mercado y productividad.";

        // --- INICIALIZACIÓN ---
        window.addEventListener('load', () => {
            updateTheme(state.config.theme);
            document.getElementById('api-key-input').value = state.config.key;
            document.getElementById('theme-select').value = state.config.theme;
            switchTab('view-dashboard');
            renderAll();
            loadNews();
            lucide.createIcons();
        });

        // --- NAVEGACIÓN ---
        function switchTab(id, el) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        }

        // --- NOTAS ---
        function showNoteModal() { document.getElementById('note-modal').classList.remove('hidden'); }
        function hideNoteModal() { document.getElementById('note-modal').classList.add('hidden'); }
        function saveNote() {
            const t = document.getElementById('note-title').value;
            const c = document.getElementById('note-text').value;
            if(!t) return;
            state.notes.unshift({ id: Date.now(), title: t, content: c, date: new Date().toISOString() });
            localStorage.setItem('vp_notes', JSON.stringify(state.notes));
            renderAll(); hideNoteModal();
            document.getElementById('note-title').value = ''; document.getElementById('note-text').value = '';
        }
        function deleteNote(id) { state.notes = state.notes.filter(n => n.id !== id); localStorage.setItem('vp_notes', JSON.stringify(state.notes)); renderAll(); }

        // --- LINKS ---
        function saveLink() {
            const url = document.getElementById('link-input').value;
            if(!url) return;
            const fullUrl = url.startsWith('http') ? url : 'https://' + url;
            state.links.unshift({ id: Date.now(), url: fullUrl });
            localStorage.setItem('vp_links', JSON.stringify(state.links));
            renderAll(); document.getElementById('link-input').value = '';
        }
        function deleteLink(id) { state.links = state.links.filter(l => l.id !== id); localStorage.setItem('vp_links', JSON.stringify(state.links)); renderAll(); }

        // --- AGENDA ---
        function saveEvent() {
            const d = document.getElementById('event-date').value;
            const s = document.getElementById('event-desc').value;
            if(!d || !s) return;
            state.events.push({ id: Date.now(), date: d, desc: s });
            localStorage.setItem('vp_events', JSON.stringify(state.events));
            renderAll();
        }
        function deleteEvent(id) { state.events = state.events.filter(e => e.id !== id); localStorage.setItem('vp_events', JSON.stringify(state.events)); renderAll(); }

        // --- RENDERIZADO ---
        function renderAll() {
            const nCont = document.getElementById('notes-container');
            nCont.innerHTML = state.notes.map(n => `
                <div class="glass-panel p-4 rounded-xl relative group">
                    <button onclick="deleteNote(${n.id})" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" size="14"></i></button>
                    <h4 class="font-bold text-blue-400 text-sm mb-1">${n.title}</h4>
                    <p class="text-[10px] text-slate-300 line-clamp-3">${n.content}</p>
                </div>
            `).join('');

            const lCont = document.getElementById('links-container');
            lCont.innerHTML = state.links.map(l => `
                <div class="glass-panel p-3 rounded-xl flex justify-between items-center">
                    <span class="text-[10px] truncate w-3/4 text-slate-400">${l.url}</span>
                    <div class="flex gap-3">
                        <a href="${l.url}" target="_blank" class="text-blue-400"><i data-lucide="external-link" size="14"></i></a>
                        <button onclick="deleteLink(${l.id})" class="text-red-500"><i data-lucide="trash-2" size="14"></i></button>
                    </div>
                </div>
            `).join('');

            const eCont = document.getElementById('events-container');
            eCont.innerHTML = state.events.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(e => `
                <div class="glass-panel p-3 rounded-xl flex justify-between items-center border-l-4 border-l-yellow-500">
                    <div>
                        <div class="text-[10px] font-bold text-white">${e.desc}</div>
                        <div class="text-[8px] text-slate-500">${new Date(e.date).toLocaleString()}</div>
                    </div>
                    <button onclick="deleteEvent(${e.id})" class="text-slate-600"><i data-lucide="x" size="14"></i></button>
                </div>
            `).join('');

            document.getElementById('dash-notes-count').innerText = state.notes.length;
            document.getElementById('dash-links-count').innerText = state.links.length;
            document.getElementById('dash-events-count').innerText = state.events.length;
            lucide.createIcons();
        }

        // --- IA ROI (ANÁLISIS NEURAL CON GROUNDING) ---
        async function runNeuralAnalysis() {
            const query = document.getElementById('analysis-query').value;
            if(!query || !state.config.key) return alert("Configura tu API Key en Perfil");
            
            const btn = document.getElementById('btn-run-analysis');
            const report = document.getElementById('analysis-report');
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> Analizando Mercado...';
            lucide.createIcons();

            try {
                // LLAMADA A GEMINI 2.0 FLASH CON BÚSQUEDA ACTIVADA (Grounding)
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.config.key}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Actúa como un experto en ROI y análisis estratégico. Investiga y genera un informe profundo sobre: ${query}.` }] }]
                    })
                });
                const data = await res.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                report.innerHTML = `
                    <div class="glass-panel p-5 rounded-2xl border-l-4 border-l-blue-500 fade-in">
                        <div class="flex items-center gap-2 mb-3 text-blue-400 font-bold text-xs">
                            <i data-lucide="file-text" size="14"></i> INFORME ESTRATÉGICO VICO
                        </div>
                        <div class="text-[10px] text-slate-300 leading-relaxed whitespace-pre-wrap">${aiText}</div>
                    </div>
                `;
            } catch(e) { alert("Error IA. Revisa tu clave o cuota."); }
            finally { btn.disabled = false; btn.innerHTML = '<i data-lucide="brain"></i> Generar Informe Real'; lucide.createIcons(); }
        }

        // --- DESCUBRE (RSS NOTICIAS) ---
        async function loadNews() {
            const cont = document.getElementById('news-container');
            cont.innerHTML = '<p class="text-xs text-blue-400 animate-pulse">Escaneando feeds globales...</p>';
            try {
                const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=https://www.xataka.com/feed`);
                const data = await res.json();
                cont.innerHTML = data.items.slice(0, 10).map(i => `
                    <div class="glass-panel rounded-2xl overflow-hidden flex flex-col">
                        <img src="${i.thumbnail || 'https://picsum.photos/400/200?sig='+Math.random()}" class="h-32 w-full object-cover">
                        <div class="p-3">
                            <h4 class="text-xs font-bold text-white mb-2 leading-tight">${i.title}</h4>
                            <a href="${i.link}" target="_blank" class="text-[9px] text-blue-400 flex items-center gap-1">LEER ARTÍCULO <i data-lucide="external-link" size="10"></i></a>
                        </div>
                    </div>
                `).join('');
            } catch(e) { cont.innerHTML = '<p class="text-red-500 text-xs text-center">Error al conectar con el servidor RSS.</p>'; }
            lucide.createIcons();
        }

        // --- POMODORO ---
        function openPomodoro() { document.getElementById('pomo-modal').classList.remove('hidden'); }
        function closePomodoro() { document.getElementById('pomo-modal').classList.add('hidden'); }
        function togglePomo() {
            if(state.pomo.active) {
                clearInterval(state.pomo.interval);
                state.pomo.active = false;
                document.getElementById('pomo-ctrl').innerHTML = '<i data-lucide="play" class="text-white"></i>';
            } else {
                state.pomo.active = true;
                document.getElementById('pomo-ctrl').innerHTML = '<i data-lucide="pause" class="text-white"></i>';
                state.pomo.interval = setInterval(() => {
                    state.pomo.time--;
                    updatePomoUI();
                    if(state.pomo.time <= 0) resetPomo();
                }, 1000);
            }
            lucide.createIcons();
        }
        function resetPomo() {
            clearInterval(state.pomo.interval);
            state.pomo.time = 1500;
            state.pomo.active = false;
            updatePomoUI();
            document.getElementById('pomo-ctrl').innerHTML = '<i data-lucide="play" class="text-white"></i>';
            lucide.createIcons();
        }
        function updatePomoUI() {
            const m = Math.floor(state.pomo.time / 60);
            const s = state.pomo.time % 60;
            const str = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            document.getElementById('pomo-timer').innerText = str;
            document.getElementById('pomo-mini').innerText = str;
            document.getElementById('pomo-mini').classList.toggle('hidden', !state.pomo.active);
        }

        // --- PACK DUVI: AJUSTES Y CHAT ---
        function detectKey(val) {
            const status = document.getElementById('key-status');
            if(val.startsWith('AIza')) { status.innerHTML = "✅ Gemini Detectado"; state.config.provider = 'gemini'; }
            else if(val.startsWith('gsk')) { status.innerHTML = "✅ Groq Detectado"; state.config.provider = 'groq'; }
            else if(val.startsWith('sk-')) { status.innerHTML = "✅ OpenAI/DeepSeek Detectado"; state.config.provider = 'openai'; }
            else status.innerHTML = "Introduce clave para detectar motor.";
        }
        function saveApiConfig() {
            state.config.key = document.getElementById('api-key-input').value;
            localStorage.setItem('vp_config', JSON.stringify(state.config));
            alert("API Guardada con éxito");
        }
        function updateTheme(t) {
            document.body.className = 'theme-' + t;
            state.config.theme = t;
            localStorage.setItem('vp_config', JSON.stringify(state.config));
        }

        function toggleChat() { document.getElementById('chat-box').classList.toggle('hidden'); }
        async function sendChatMessage() {
            const inp = document.getElementById('chat-input');
            const msgs = document.getElementById('chat-msgs');
            if(!inp.value || !state.config.key) return;
            
            const userTxt = inp.value;
            msgs.innerHTML += `<div class="bg-blue-600/20 p-2 rounded-lg text-right ml-10 text-slate-200">${userTxt}</div>`;
            inp.value = ''; msgs.scrollTop = msgs.scrollHeight;

            try {
                // TRUCO PROXY ANTI-CORS PARA GROQ (Pack DUVI)
                let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.config.key}`;
                let body = { contents: [{ parts: [{ text: VICO_PROMPT + " " + userTxt }] }] };

                if(state.config.provider === 'groq') {
                    url = "https://corsproxy.io/?https://api.groq.com/openai/v1/chat/completions";
                    body = { model: "llama-3.3-70b-versatile", messages: [{role:"system", content: VICO_PROMPT}, {role:"user", content: userTxt}] };
                }

                const res = await fetch(url, {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${state.config.key}` },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                const reply = state.config.provider === 'gemini' ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
                msgs.innerHTML += `<div class="bg-slate-800 p-2 rounded-lg mr-10">VICO: ${reply}</div>`;
            } catch(e) { msgs.innerHTML += `<div class="text-red-400">Error IA de conexión...</div>`; }
            msgs.scrollTop = msgs.scrollHeight;
        }
    </script>
</body>
  </html>
